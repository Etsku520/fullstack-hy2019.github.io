<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/0.08be0af6e32173234671.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400);.element--flex{display:flex;flex-wrap:wrap}.element--space-around{justify-content:space-around}.element--space-between{justify-content:space-between}.element--column{flex-direction:column}.element--centered{align-items:center;justify-content:center!important}@media (min-width:992px){.element--centered-in-desktop{align-items:center;justify-content:center!important}}@media (min-width:992px){.element--horizontal-half{width:45%}}.element--auto-margin{margin:auto}.element--auto-bottom-margin{margin-bottom:auto}.element--flex-start{align-content:flex-start}.element--no-wrap{flex-wrap:nowrap}.element--relative{position:relative!important}.image__content{position:absolute;top:0;left:0;height:100%;width:100%;-o-object-fit:cover;object-fit:cover}.image--contain .image__content{-o-object-fit:contain;object-fit:contain}.image{overflow:hidden;width:100%;position:relative}@media (min-width:992px){.image{width:40%}}.image .image__container{height:0;position:relative;width:100%;padding-bottom:89.0625%}.image--circle{border-radius:50%}.image--circle .image__content{background-color:#e1e1e1}.image--square-big{width:100%}.image--square-big .image__container{width:100%;padding-bottom:100%}.image--extra-small{width:8%}.image--extra-small .image__container{width:100%;padding-bottom:100%}@media (max-width:639px){.image--extra-small{width:calc(33.33333% - 1rem)}}.image--small{width:15%}.image--small .image__container{width:100%;padding-bottom:100%}@media (max-width:639px){.image--small{width:calc(33.33333% - 1rem)}}.image--medium{width:50%}.image--medium .image__container{width:100%;padding-bottom:71.25%}.image--large{width:100%}@media (min-width:992px){.image--large{width:60%}}.image--large .image__container{padding-bottom:59.37%;width:100%}.image--full-width{width:100%}.image--full-width .image__container{padding-bottom:59.37%;width:100%}.image--actual-size{width:100%}.image--actual-size .image__container{height:0;position:relative;width:100%;padding-bottom:60%}.navigation{z-index:2;list-style:none;opacity:0;display:none;margin:0;padding:5%;flex-direction:column;justify-content:center;align-items:center;background:#e1e1e1;position:fixed;top:8%;right:5%;transition:opacity .3s ease-in-out;font-weight:200}@media (min-width:640px){.navigation{display:flex;opacity:1;padding:0;font-weight:400;position:static;background:none;overflow:hidden;flex-direction:row}}.navigation__toggle{z-index:3;position:absolute;top:0;right:0;width:50px;height:40px;cursor:pointer;border:none;background:none;outline:none;border-radius:4px}@media (min-width:640px){.navigation__toggle{display:none}}.navigation__mobile-logo{display:none}.navigation__toggle-icon{top:8px;left:10px}.navigation__toggle-icon,.navigation__toggle-icon:after,.navigation__toggle-icon:before{position:absolute;width:30px;height:3px;transition:all .3s ease;border-radius:4px;background-color:#33332d}.navigation__toggle-icon:after,.navigation__toggle-icon:before{content:"";display:block}.navigation__toggle-icon:before{top:10px}.navigation__toggle-icon:after{top:20px}.is-open--navigation{overflow:hidden}.is-open--navigation .navigation{opacity:1;display:unset}.is-open--navigation .navigation:before{content:"";background-color:#e1e1e1;position:absolute;width:25px;height:25px;top:-3px;right:13px;-webkit-transform:rotate(45deg);transform:rotate(45deg)}.is-open--navigation .navigation__mobile-logo{display:block;width:30px;height:30px;position:absolute;top:47px;left:5%}@media (min-width:640px){.is-open--navigation .navigation__mobile-logo{display:none}}.is-open--navigation .navigation__toggle-icon{-webkit-transform:translate3d(0,10px,0) rotate(45deg);transform:translate3d(0,10px,0) rotate(45deg)}.is-open--navigation .navigation__toggle-icon,.is-open--navigation .navigation__toggle-icon:after,.is-open--navigation .navigation__toggle-icon:before{background:#33332d}.is-open--navigation .navigation__toggle-icon:before{-webkit-transform:rotate(-45deg) translate3d(-5.71429px,-6px,0);transform:rotate(-45deg) translate3d(-5.71429px,-6px,0);opacity:0}.is-open--navigation .navigation__toggle-icon:after{-webkit-transform:translate3d(0,-19px,0) rotate(-90deg);transform:translate3d(0,-19px,0) rotate(-90deg)}.navigation__item{margin:22px 0;white-space:nowrap}.navigation__item:first-of-type{margin:0 0 22px}.navigation__item:last-of-type{margin:22px 0 0}@media (min-width:640px){.navigation__item{margin:0 30px;padding:0!important}.navigation__item:first-of-type{margin:0 30px 0 2rem}.navigation__item:last-of-type{margin:0 0 0 30px}}html{font-family:IBM Plex Mono,monospace;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:IBM Plex Mono,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em IBM Plex Mono,monospace;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:IBM Plex Mono,monospace;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{margin:2rem 0 -.5rem;font-size:1.38316rem}h3,h4{padding:0;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{margin:2rem 0 -1rem;font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}body,html{margin:0;padding:0;font-family:IBM Plex Mono,monospace;font-weight:500;color:#33332d;font-size:14px;line-height:1.555rem}@media (min-width:992px){body,html{font-size:18px}}p{margin:0;text-align:left;line-height:1.5em}a,p{color:#33332d}a{text-decoration:none}.link a{border-bottom:2px solid #e1e1e1}.container{position:relative;margin:0 auto;display:flex;flex-wrap:wrap;justify-content:space-between;width:90%;max-width:1200px}@media (min-width:992px){.container--right{margin-right:5%;width:54%;max-width:719.9856px}}@media (min-width:992px) and (min-width:1200px){.container--right{margin-right:calc((100% - 1200px)/2)}}.hidden{display:none!important}.centered{text-align:center}@media (max-width:639px){.centered--mobile{justify-content:center;align-content:center;align-items:center}}.spacing{margin-top:2rem}@media (min-width:992px){.spacing{margin-top:5rem}}.spacing--small{margin-top:1rem}@media (min-width:992px){.spacing--small{margin-top:3.444rem}}.spacing--large{margin-top:4rem}@media (min-width:992px){.spacing--large{margin-top:10rem}}.spacing--extra-large{margin-top:4rem}@media (min-width:992px){.spacing--extra-large{margin-top:20rem}}.spacing--after{margin-bottom:2rem}@media (min-width:992px){.spacing--after{margin-bottom:5rem}}@media (min-width:992px){.spacing--after-small{margin-bottom:2.5rem}}.spacing--after-large{margin-bottom:4rem}@media (min-width:992px){.spacing--after-large{margin-bottom:10rem}}@media (max-width:991px){.spacing--mobile{margin-top:2rem}}.col-1{width:100%}@media (min-width:992px){.col-1{width:10%}}.col-2{width:100%}@media (min-width:992px){.col-2{width:20%}}.col-3{width:100%}@media (min-width:992px){.col-3{width:30%}}.col-4{width:100%}@media (min-width:992px){.col-4{width:40%}}.col-5{width:100%}@media (min-width:992px){.col-5{width:50%}}.col-6{width:100%}@media (min-width:992px){.col-6{width:60%}}.col-7{width:100%}@media (min-width:992px){.col-7{width:70%}}.col-8{width:100%}@media (min-width:992px){.col-8{width:80%}}.col-9{width:100%}@media (min-width:992px){.col-9{width:90%}}.col-10{width:100%}@media (min-width:992px){.col-10{width:100%}}@media (min-width:992px){.push-right-1{margin-left:10%}.push-right-2{margin-left:20%}.push-right-3{margin-left:30%}.push-right-4{margin-left:40%}.push-right-5{margin-left:50%}.push-left-1{margin-right:10%}.push-left-2{margin-right:20%}.push-left-3{margin-right:30%}.push-left-4{margin-right:40%}.push-left-5{margin-right:50%}.push-left{margin-right:auto}.push-right{margin-left:auto}}@media (max-width:991px){.col-1--mobile{width:10%}.col-2--mobile{width:20%}.col-3--mobile{width:30%}.col-4--mobile{width:40%}.col-5--mobile{width:50%}.col-6--mobile{width:60%}.col-7--mobile{width:70%}.col-8--mobile{width:80%}.col-9--mobile{width:90%}.col-10--mobile{width:100%}.order-0--mobile{order:0}.order-1--mobile{order:1}.order-2--mobile{order:2}.order-3--mobile{order:3}.order-4--mobile{order:4}.order-5--mobile{order:5}.hidden--mobile{display:none}}.centered-vertically{display:flex;flex-direction:column;justify-content:center}.nav-item-hover{text-decoration:none;color:#33332d;font-weight:500;padding:.2em}@media (min-width:640px){.nav-item-hover{font-weight:600;font-size:1.111rem}}.nav-item-hover:active,.nav-item-hover:focus,.nav-item-hover:hover{color:#fff;background-color:#33332d}.nav-item-hover:active,.nav-item-hover:focus{outline:2px solid #706be4}.flex-fix-aligning:after,.flex-fix-aligning:before{content:"";width:30%;order:2}.index__main-title{font-size:1.571rem}@media (min-width:992px){.index__main-title{font-size:3rem}}.auto-bottom-margin{margin-bottom:auto}@media (min-width:992px){.absolute-top-right--desktop{position:absolute;top:0;right:0}}@media (min-width:640px){.frontpage__hero .image{top:-2em}}@media (min-width:992px){.frontpage__hero{flex-direction:column}.frontpage__hero .image{top:4em}}.heading-font{font-family:IBM Plex Sans,monospace}.header{position:-webkit-sticky;position:sticky;z-index:200;top:0;transition:top .2s ease-in-out;box-sizing:border-box;width:100%;padding-top:1.444rem;padding-bottom:1rem;transition:all .2s ease-in-out}.header__logo{margin:0 10px}.triple-border{position:relative;padding:2px;border-radius:5px 0;transition:color .1s ease-in-out,background-color .1s ease-in-out}.triple-border:after,.triple-border:before{content:"";border:2px solid #33332d;border-radius:5px;position:absolute;width:calc(100% + 5px);height:calc(100% + 5px)}.triple-border:before{left:0;top:0}.triple-border:after{bottom:0;right:0}.triple-border__container{overflow:hidden;border-radius:3px 0}.triple-border--large-margin{margin:13px;padding:3px}.triple-border--large-margin:after,.triple-border--large-margin:before{content:"";border-width:3px;border-radius:13px;width:calc(100% + 13px);height:calc(100% + 13px)}.triple-border--large-margin .triple-border__container{border-radius:10px 0}.triple-border__logo{padding:.2rem;font-size:1.111rem;font-weight:600}.triple-border__return-tasks{font-size:.9rem;padding:1rem .2rem}</style><style data-href="/app.f588656cc80a065e5f1e.css">code[class*=language-],pre[class*=language-]{color:#fff;background:none;text-shadow:0 -.1em .2em #000;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}:not(pre)>code[class*=language-],pre[class*=language-]{background:#4d4033}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border:.3em solid #7a6652;border-radius:.5em;box-shadow:inset 1px 1px .5em #000}:not(pre)>code[class*=language-]{padding:.15em .2em .05em;border-radius:.3em;border:.13em solid #7a6652;box-shadow:inset 1px 1px .3em -.1em #000;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#998066}.namespace,.token.punctuation{opacity:.7}.token.boolean,.token.constant,.token.number,.token.property,.token.symbol,.token.tag{color:#d1949e}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#bde052}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f5b83d}.token.atrule,.token.attr-value,.token.keyword{color:#d1949e}.token.important,.token.regex{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.deleted{color:red}</style><style data-href="/component---src-templates-content-template-js.1385f836cbf7ad252820.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400);.course{position:relative;width:100%}.course p{font-family:IBM Plex Sans,monospace}@media (min-width:640px){.course p{margin-left:1rem}}.course p:not(:last-of-type){margin-bottom:1rem}@media (min-width:640px){.course h1{margin-left:3rem}}.course h2,.course h3,.course h4{padding-bottom:2rem}@media (min-width:640px){.course h2,.course h3,.course h4,.course table{margin-left:1rem}}.course ul{font-family:IBM Plex Sans,monospace}@media (min-width:640px){.course ul{margin-left:2.2rem}}.course h2:not(:first-of-type){margin-top:2rem}.course pre{margin:2rem 0;background-color:#33332d;color:#fff}.course em{font-family:Courier;font-style:normal;background-color:hsla(0,0%,88.2%,.6);padding:1px 5px 2px}.course img{border:11px solid transparent}.course .banner,.course .container{position:static}.course .letter{width:4rem;height:4rem;border-width:5px;border-style:solid;border-radius:2.5rem;text-align:center;margin:1rem;line-height:1.3em;-webkit-transform:translate(-1rem);transform:translate(-1rem)}@media (min-width:640px){.course .letter{-webkit-transform:translate(-3rem,4.5rem);transform:translate(-3rem,4.5rem)}}.course .letter,.course h1{font-size:2.3rem;font-weight:700}.course-content a,.tasks a{border:0;border-bottom-width:2px;border-style:solid;padding:2px}.course-content{max-width:100%}.tasks a{border-color:#33332d!important}.gatsby-highlight-code-line{background-color:hsla(0,0%,88.2%,.3);display:block;margin-right:-1em;margin-left:-1em;padding-right:1em;padding-left:1em}code[class*=language-],pre[class*=language-]{text-shadow:none}.arrow-go-up{width:36px;height:36px;position:fixed;bottom:5%;right:5%;z-index:99999;cursor:pointer}@media (max-width:639px){.arrow-go-up{right:10%}}.arrow__container{position:relative}.arrow__container:not():first-child{background:none;background-color:none}@media (min-width:640px){.arrow__container:not():first-child{border-left:none}.arrow__container:not():first-child:before{content:"";background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NzcuMTc1IDQ3Ny4xNzUiPjxwYXRoIGQ9Ik0zNjAuNzMxIDIyOS4wNzVsLTIyNS4xLTIyNS4xYy01LjMtNS4zLTEzLjgtNS4zLTE5LjEgMHMtNS4zIDEzLjggMCAxOS4xbDIxNS41IDIxNS41LTIxNS41IDIxNS41Yy01LjMgNS4zLTUuMyAxMy44IDAgMTkuMSAyLjYgMi42IDYuMSA0IDkuNSA0IDMuNCAwIDYuOS0xLjMgOS41LTRsMjI1LjEtMjI1LjFjNS4zLTUuMiA1LjMtMTMuOC4xLTE5eiIvPjwvc3ZnPg==) no-repeat;background-size:contain;position:absolute;top:0;left:0;height:100%;width:100%}}.arrows--horizontal{display:flex;position:relative;margin:0;align-items:flex-start}.arrow__wrapper{display:flex;justify-content:flex-start;align-items:center;margin:0}.arrow__wrapper:first-of-type{border-right:none;z-index:20}.arrow__wrapper:nth-of-type(n+2){margin-left:-4rem;z-index:10}.arrow__wrapper:nth-of-type(n+2) .arrow__rectangle{border-left:none;padding-left:4rem}.arrow__wrapper:nth-of-type(3){z-index:5}.arrow__rectangle{padding:1rem;justify-content:center;align-items:center;border:2px solid #33332d;border-right:none;z-index:2;overflow:hidden;font-family:IBM Plex Sans,monospace;position:relative}@media (max-width:991px){.arrow__rectangle{font-size:.7rem}}.arrow__rectangle .bold{font-weight:600}.arrow__rectangle--thick-border{border:3px solid #33332d;border-right:none}.arrow__point{padding:1.25rem;border:2px solid #33332d;border-bottom:none;border-left:none;-webkit-transform:translate(-1.3rem) rotate(45deg);transform:translate(-1.3rem) rotate(45deg);z-index:1;overflow:hidden}.arrow__point--thick-border{border:3px solid #33332d;border-bottom:none;border-left:none}.arrow__wrapper--stacked{display:flex;justify-content:flex-start;align-items:center;margin:auto auto auto 0}.arrow__wrapper--stacked:nth-of-type(n+2){margin-top:1rem}@media (min-width:640px){.arrow__wrapper--stacked:nth-of-type(n+2){margin-top:-2px}}.arrow__wrapper--stacked .arrow__rectangle{position:relative}@media (min-width:640px){.arrow__wrapper--stacked .arrow__rectangle{padding:1.25rem}}@media (min-width:992px){.arrow__wrapper--stacked .arrow__rectangle{padding:1rem}}.arrow__wrapper--stacked .arrow__point{padding:1.08rem;margin-left:2px}@media (min-width:640px){.arrow__wrapper--stacked .arrow__point{margin-left:unset;padding:1.25rem}}.arrow__wrapper--stacked:hover .arrow__point,.arrow__wrapper--stacked:hover .arrow__rectangle{background-color:#33332d!important}.arrow__wrapper--stacked:hover .arrow--stacked-letter,.arrow__wrapper--stacked:hover .arrow--stacked-title{color:#fff}.arrow--stacked-letter{margin-right:2rem}.arrow--stacked-title{white-space:nowrap;font-family:IBM Plex Mono,monospace}.arrow__container--with-link{width:100%!important}@media (max-width:639px){.breadcrumb .arrow__wrapper{padding:0}.breadcrumb .arrow__wrapper:not(:last-of-type):after{content:">";font-size:.7rem;font-weight:400;margin:0 .5rem}}.breadcrumb .arrow__rectangle{position:relative}@media (max-width:639px){.breadcrumb .arrow__rectangle{border:none;padding:0;font-size:.7rem;white-space:nowrap;background-color:transparent!important;color:#33332d}}@media (max-width:639px){.breadcrumb .arrow__point{display:none}}.banner{display:flex;width:100%;align-items:center;position:relative;padding:2rem 0;background-color:#e1e1e1}@media (min-width:992px){.banner{padding:3.444rem 3.444rem 4.444rem}}.edit-link{border-bottom-width:3px;border-bottom-style:solid}@media (min-width:992px){#footer{align-items:center}}#footer .footer__navigation-link{font-size:1rem;line-height:18px;white-space:nowrap;font-family:IBM Plex Sans,monospace;margin-left:0!important}#footer .footer__navigation-link:nth-of-type(n+2){margin-top:2.142rem}@media (min-width:992px){#footer .footer__navigation{flex-direction:row;flex-wrap:nowrap;justify-content:flex-end}#footer .footer__navigation-link{margin-top:0!important;margin-bottom:auto}#footer .footer__navigation-link:nth-of-type(n+1){margin-right:2.877rem}#footer .footer__navigation-link:last-of-type{margin-right:0!important}}.prev-next__container .separator{display:none}@media (max-width:639px){.prev-next__container .separator{display:block;background-color:#33332d;width:2px}}.prev-next__container .prev b,.prev-next__container .prev p{text-align:right}@media (max-width:639px){.prev-next__container .prev p:before{content:"<";margin-right:1rem}}@media (max-width:639px){.prev-next__container .next p:after{content:">";margin-left:1rem}}.body-text:not(:last-of-type){margin-bottom:2.5rem}.body-text__title{color:#33332d;font-size:1.44rem;line-height:1.25em;font-weight:700;margin:0;position:relative;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.body-text__content:not(:last-of-type){padding-bottom:2em}.bold{font-weight:700}.body-text--no-padding{padding:0!important}.scroll-navigation{font-size:16px;position:absolute;width:30%;left:0;top:198px;padding-right:1rem;z-index:199}@media (max-width:991px){.scroll-navigation{display:none}}.scroll-navigation li{list-style-type:none}.scroll-navigation li:hover{cursor:pointer}.scroll-navigation li:hover a{background-color:#33332d;color:#fff!important}.scroll-navigation li:before{content:"-"}.left-navigation-link{padding-left:1.2rem;text-indent:-1.2rem}.left-navigation-link:hover{background-color:#33332d!important;color:#fff!important}.level-h1{font-weight:700;padding-left:2.8rem;text-indent:-2.8rem}.level-h2{padding-left:1.6rem;text-indent:-1.6rem}.accordion__container{margin-bottom:1rem}.accordion__title{padding-left:2.149rem!important;padding-right:2.149rem!important;font-size:1.111rem!important;font-weight:600}.accordion{background-color:#fff;border:3px solid #33332d;border-radius:5px;color:#444;cursor:pointer;padding:1rem;width:100%;text-align:left;outline:none;font-size:15px;transition:max-width .4s}.accordion:hover,.active{background-color:#ccc}.accordion:after{content:"\2795";font-size:1rem;color:#33332d;float:right;margin-left:5px}.active{border-color:#fff}.active:after{content:"\2796"}.panel{background-color:#fff;transition:height .3s;transition-timing-function:ease-in-out;overflow:hidden}.accordion--side-navigation{width:100%;margin-left:unset}.accordion--side-navigation .accordion{border:none;padding:0!important;background-color:transparent!important;color:#33332d!important;border-radius:0}.accordion--side-navigation .accordion__title{font-size:16px!important;font-weight:unset;background-color:transparent}.accordion--side-navigation .accordion__title:hover{background-color:#33332d!important;color:#fff!important}.accordion--side-navigation .panel{padding:1rem 0 0!important;background-color:transparent}.accordion--side-navigation .panel ul{margin-left:1rem}.accordion--side-navigation .accordion:hover,.accordion--side-navigation .active{background-color:#33332d;color:#fff}.accordion--side-navigation .accordion:after,.accordion--side-navigation .active:after{content:""}.sub-header{color:#33332d;font-family:IBM Plex Mono,monospace;padding-bottom:1.357rem}@media (min-width:992px){.sub-header{padding-bottom:2.333rem}}</style><meta name="generator" content="Gatsby 2.0.53"/><title data-react-helmet="true">Fullstack osa4 |  | Fullstack 2019</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="Fullstack osa4 | "/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Houston Inc. Consulting oy"/><meta data-react-helmet="true" name="twitter:title" content="Fullstack osa4 | "/><meta data-react-helmet="true" name="twitter:description" content=""/><meta data-react-helmet="true" name="keywords" content="Fullstack, "/><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link as="script" rel="preload" href="/app-4587c720de4a14625975.js"/><link as="script" rel="preload" href="/1-456d0b929a90ce0c027e.js"/><link as="script" rel="preload" href="/component---src-templates-content-template-js-b9333370503a7987b2f7.js"/><link as="script" rel="preload" href="/2-e0028e5792f6cb5e6fe8.js"/><link as="script" rel="preload" href="/0-2703ff4545207292aaf8.js"/><link as="script" rel="preload" href="/3-7bca983c2bafa9f6e675.js"/><link as="script" rel="preload" href="/webpack-runtime-5a19fe3c89021bc3230c.js"/><link rel="preload" href="/static/d/305/path---osa-4-sovelluksen-rakenne-ja-testauksen-alkeet-058-b44-dvrCmWnaqg5szKs3E2gITf7uec.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="header " style="background-color:white"><div class="container" style="align-items:center;justify-content:flex-start"><a class="header__logo" href="/"><div class="triple-border nav-item-hover " style="padding:0.2em"><div class="triple-border__container triple-border__logo" style="background-color:transparent">{() =&gt; fs}</div></div></a><div class="navigation__wrapper "><button aria-label="Navigation menu" aria-expanded="false" class="navigation__toggle"><div class="navigation__toggle-icon"></div></button><nav><ul class="navigation"><li class="navigation__item "><a class="nav-item-hover" href="/about">KURSSISTA</a></li><li class="navigation__item "><a class="nav-item-hover" href="/#course-contents">KURSSIN SISÄLTÖ</a></li><li class="navigation__item "><a class="nav-item-hover" href="/faq">FAQ</a></li></ul></nav></div></div></div><div class="course-container spacing--after"><div class="banner " style="background-image:url(/static/part-4-5c308a7f2485495a6c24db46e9910185.svg);background-position:center center;background-size:50%;background-repeat:no-repeat;background-color:#F7F382"><div class="container spacing--after"><div class="col-10 spacing--after"><div class="arrow__container arrows--horizontal breadcrumb"><div class="arrow__wrapper"><div class="arrow__rectangle  " style="background-color:#F7F382;color:#33332d"><a href="/#course-contents">Fullstack</a></div><div class="arrow__point " style="background-color:#F7F382;color:#33332d"></div></div><div class="arrow__wrapper"><div class="arrow__rectangle  " style="background-color:#F7F382;color:#33332d"><a href="/osa4">osa 4</a></div><div class="arrow__point " style="background-color:#F7F382;color:#33332d"></div></div><div class="arrow__wrapper"><div class="arrow__rectangle  " style="background-color:#33332d;color:white">Sovelluksen rakenne ja testauksen alkeet</div><div class="arrow__point " style="background-color:#33332d;color:white"></div></div></div></div></div></div><div class="course "><div class="container element--flex element--relative"><div class="scroll-navigation col-2 spacing element--flex element--column" tag="ul"><div class="accordion__container col-8 push-right-1 accordion--side-navigation"><button class="accordion accordion__title  " style="background-color:#F7F382;border-color:#F7F382">a Sovelluksen rakenne ja testauksen alkeet</button><div class="panel" style="padding:;max-height:0;transition:max-height 0.2s ease-out"><ul></ul></div></div></div><div class="course-content col-6 push-right-3 element--auto-bottom-margin"><p class="col-1 letter" style="border-color:#F7F382">a</p><h1 class="sub-header ">Sovelluksen rakenne ja testauksen alkeet</h1></div></div><div class="container"><div class="course-content col-6 push-right-3">
<p>Jatketaan <a href="/osa3">osassa 3</a> tehdyn muistiinpanosovelluksen backendin kehittämistä.</p>
<h3>Sovelluksen rakenne</h3>
<p>Ennen osan ensimmäistä isoa teemaa eli testaamista, muutetaan sovelluksen rakennetta noudattamaan paremmin Noden <a href="https://github.com/i0natan/nodebestpractices/tree/master/sections/projectstructre">parhaita käytänteiä</a>.</p>
<p>Seuraavassa läpikäytävien muutosten jälkeen sovelluksemme hakemistorakenne näyttää seuraavalta</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash">├── index.js
├── app.js
├── build
│   ├── <span class="token punctuation">..</span>.
├── controllers
│   └── notes.js
├── models
│   └── note.js
├── package-lock.json
├── package.json
├── utils
│   ├── config.js
│   └── middleware.js  </code></pre></div>
<p>Sovelluksen käynnistystiedosto <i>index.js</i> pelkistyy seuraavaan muotoon:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./app&#x27;</span><span class="token punctuation">)</span> <span class="token comment">// varsinainen Express-sovellus</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./utils/config&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p><i>index.js</i> ainoastaan importaa tiedostossa <i>app.js</i> olevan varsinaisen sovelluksen ja käynnistää sen. Sovelluksen käynnistäminen tapahtuu nyt <em>server</em>-muuttujassa olevan olion kautta. </p>
<p>Ympäristömuuttujien käsittely on eriytetty moduulin <i>utils/config.js</i> vastuulle:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#x27;production&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;dotenv&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> <span class="token constant">PORT</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span>
<span class="token keyword">let</span> <span class="token constant">MONGODB_URI</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">MONGODB_URI</span><span class="token punctuation">,</span>
  <span class="token constant">PORT</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Sovelluksen muut osat pääsevät ympäristömuuttujiin käsiksi importtaamalla konfiguraatiomoduulin</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./utils/config&#x27;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span></code></pre></div>
<p>Routejen määrittely siirretään omaan tiedostoonsa, eli myös siitä tehdään moduuli. Routejen tapahtumankäsittelijöitä kutsutaan usein <i>kontrollereiksi</i>. Sovellukselle onkin luotu hakemisto <i>controllers</i> ja sinne tiedosto <i>notes.js</i>, johon kaikki muistiinpanoihin liittyvien reittien määrittelyt on siirretty.</p>
<p>Tiedoston sisältö on seuraava:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> notesRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../models/note&#x27;</span><span class="token punctuation">)</span>

notesRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>notes <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> note<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

notesRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/:id&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Note<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>note<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>note<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

notesRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> request<span class="token punctuation">.</span>body

  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> body<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> body<span class="token punctuation">.</span>important <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>savedNote <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>savedNote<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

notesRouter<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">&#x27;/:id&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Note<span class="token punctuation">.</span><span class="token function">findByIdAndRemove</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

notesRouter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&#x27;/:id&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> request<span class="token punctuation">.</span>body

  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> body<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> body<span class="token punctuation">.</span>important<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  Note<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> note<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">new</span><span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>updatedNote <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>updatedNote<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> notesRouter</code></pre></div>
<p>Kyseessä on käytännössä melkein suora copypaste tiedostosta <i>index.js</i>.</p>
<p>Muutoksia on muutama. Tiedoston alussa luodaan <a href="http://expressjs.com/en/api.html#router">router</a>-olio:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> notesRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//...</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> notesRouter</code></pre></div>
<p>Tiedosto eksporttaa moduulin käyttäjille määritellyn routerin.</p>
<p>Kaikki määriteltävät routet liitetään router-olioon, samaan tapaan kuin aiemmassa versiossa routet liitettiin sovellusta edustavaan olioon.</p>
<p>Huomioinarvoinen seikka routejen määrittelyssä on se, että polut ovat typistyneet, aiemmin määrittelimme esim.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">app<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes/:id&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code></pre></div>
<p>nyt riittää määritellä</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">notesRouter<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">&#x27;/:id&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></code></pre></div>
<p>Mistä routereissa oikeastaan on kyse? Expressin manuaalin sanoin</p>
<blockquote>
<p><i>A router object is an isolated instance of middleware and routes. You can think of it as a “mini-application,” capable only of performing middleware and routing functions. Every Express application has a built-in app router.</i></p>
</blockquote>
<p>Router on siis <i>middleware</i>, jonka avulla on mahdollista määritellä joukko &quot;toisiinsa liittyviä&quot; routeja yhdessä paikassa, yleensä omassa moduulissaan.</p>
<p>Varsinaisen sovelluslogiikan määrittelevä tiedosto <i>app.js</i> ottaa määrittelemämme routerin käyttöön seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> notesRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./controllers/notes&#x27;</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">,</span> notesRouter<span class="token punctuation">)</span></code></pre></div>
<p>Näin määrittelemäämme routeria käytetään <i>jos</i> polun alkuosa on <i>/api/notes</i>. notesRouter-olion sisällä täytyy tämän takia käyttää ainoastaan polun loppuosia, eli tyhjää polkua <i>/</i> tai pelkkää parametria <i>/:id</i>.</p>
<p>Sovelluksen määrittelevä <i>app.js</i> näyttää muutosten jälkeen seuraavalta:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./utils/config&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;express&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;body-parser&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> notesRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./controllers/notes&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./utils/middleware&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;commecting to&#x27;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span><span class="token punctuation">)</span>

mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;connected to MongoDB&#x27;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;error connection to MongoDB:&#x27;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">&#x27;build&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span>requestLogger<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">,</span> notesRouter<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span>unknownEndpoint<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">.</span>errorHandler<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> app</code></pre></div>
<p>Tiedostossa siis otetaan käyttöön joukko middlewareja, näistä yksi on polkuun <i>/api/notes</i> kiinnitettävä <i>notesRouter</i> (tai notes-kontrolleri niin kuin jotkut sitä kutsuisivat).</p>
<p>Itse toteutettujen middlewarejen määritelty on siirretty tiedostoon <i>utils/middleware.js</i>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">requestLogger</span> <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Method:&#x27;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Path:  &#x27;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Body:  &#x27;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;---&#x27;</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">unknownEndpoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">&#x27;unknown endpoint&#x27;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#x27;CastError&#x27;</span> <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#x27;ObjectId&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">&#x27;malformatted id&#x27;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#x27;ValidationError&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  requestLogger<span class="token punctuation">,</span>
  unknownEndpoint<span class="token punctuation">,</span>
  errorHandler
<span class="token punctuation">}</span></code></pre></div>
<p>Koska tietokantayhteyden muodostaminen on siirretty tiedoston <i>app.js</i>:n vastuulle. Hakemistossa <i>models</i> oleva tiedosto <i>note.js</i> sisältää nyt ainoastaan muistiinpanojen skeeman määrittelyn.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> noteSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  content<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    required<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minlength<span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  date<span class="token punctuation">:</span> Date<span class="token punctuation">,</span>
  important<span class="token punctuation">:</span> Boolean<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

noteSchema<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">&#x27;toJSON&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transform<span class="token punctuation">:</span> <span class="token punctuation">(</span>document<span class="token punctuation">,</span> returnedObject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    returnedObject<span class="token punctuation">.</span>id <span class="token operator">=</span> returnedObject<span class="token punctuation">.</span>_id
    <span class="token keyword">delete</span> returnedObject<span class="token punctuation">.</span>_id
    <span class="token keyword">delete</span> returnedObject<span class="token punctuation">.</span>__v
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&#x27;Note&#x27;</span><span class="token punctuation">,</span> noteSchema<span class="token punctuation">)</span></code></pre></div>
<p>Sovelluksen hakemistorakenne siis näyttää refaktoroinnin jälkeen seuraavalta:</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash">├── index.js
├── app.js
├── build
│   ├── <span class="token punctuation">..</span>.
├── controllers
│   └── notes.js
├── models
│   └── note.js
├── package-lock.json
├── package.json
├── utils
│   ├── config.js
│   └── middleware.js  </code></pre></div>
<p>Jos sovellus on pieni, ei rakenteella ole kovin suurta meritystä. Sovelluksen kasvaessa kannattaa sille muodostaa jonkinlainen rakenne eli arkkitehtuuri, ja jakaa erilaisten vastuut omiin moduuleihin. Tämä helpottaa huomattavasti ohjelman jatkokehitystä.</p>
<p>Express-sovelluksien rakenteelle, eli hakemistojen ja tiedostojen nimennälle ei ole olemassa mitään yleismaailmallista standardia samaan tapaan kuin esim. Ruby on Railsissa. Tässä käyttämämme malli noudattaa eräitä internetissä vastaan tulevia hyviä käytäntöjä.</p>
<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/fullstack-hy2019/part3-notes-backend/tree/part4-1">githubissa</a>, branchissa <i>part4-1</i>:</p>
<p>Jos kloonaat projektin itsellesi, suorita komento <em>npm install</em> ennen käynnistämistä eli komentoa <em>npm start</em>.</p>
</div></div>
<div class="banner spacing spacing--after tasks" style="background-color:#F7F382"><div class="container"><div class="course-content col-6 push-right-3" style="border-color:#F7F382">
<h3>Tehtäviä</h3>
<p>Rakennamme tämän osan tehtävissä <i>blogilistasovellusta</i>, jonka avulla käyttäjien on mahdollista tallettaa tietoja internetistä löytämistään mielenkiintoisista blogeista. Kustakin blogista talletetaan sen kirjoittaja (author), aihe (title), url sekä blogilistasovelluksen käyttäjien antamien äänien määrä.</p>
</div></div></div>
<div class="container"><div class="course-content col-6 push-right-3">
<h3>Node-sovellusten testaaminen</h3>
<p>Olemme laiminlyöneet ikävästi yhtä oleellista ohjelmistokehityksen osa-aluetta, automatisoitua testaamista.</p>
<p>Aloitamme yksikkötestauksesta. Sovelluksemme logiikka on sen verran yksinkertaista, että siinä ei ole juurikaan mielekästä yksikkötestattavaa. Luodaan tiedosto <i>utils/for_testing.js</i> ja määritellään sinne pari yksinkertaista funktiota testattavaksi:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">palindrom</span> <span class="token operator">=</span> string <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> string
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">average</span> <span class="token operator">=</span> array <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sum <span class="token operator">+</span> item
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> array<span class="token punctuation">.</span>length
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  palindrom<span class="token punctuation">,</span>
  average<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>Metodi <em>average</em> käyttää taulukoiden metodia <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce">reduce</a>. Jos metodi ei ole vieläkään tuttu, on korkea aika katsoa youtubesta <a href="https://www.youtube.com/watch?v=BMUiFMZr7vk&amp;list=PL0zVEGEvSaeEd9hlmCXrk5yUyqUag-n84">Functional Javascript</a> -sarjasta ainakin kolme ensimmäistä videoa.</p>
</blockquote>
<p>Javascriptiin on tarjolla runsaasti erilaisia testikirjastoja eli <i>test runnereita</i>. Käytämme tällä kurssilla Facebookin kehittämää ja sisäisesti käyttämää <a href="https://jestjs.io/">jest</a>:iä, joka on toiminnaltaan ja syntaksiltaankin hyvin samankaltainen kuin testikirjastojen entinen kuningas <a href="https://mochajs.org/">Mocha</a>. Muitakin mahdollisuuksia olisi, esim. eräissä piireissä suosiota nopeasti saavuttanut <a href="https://github.com/avajs/ava">ava</a>.</p>
<p>Jest on tälle kurssille luonteva valinta, sillä se sopii hyvin backendien testaamiseen, mutta suorastaan loistaa Reactilla tehtyjen frontendien testauksessa.</p>
<blockquote>
<p><i><strong>Huomio Windows-käyttäjille:</strong></i> jest ei välttämättä toimi, jos projektin hakemistopolulla on hakemisto, jonka nimessä on välilyöntejä.</p>
</blockquote>
<p>Koska testejä on tarkoitus suorittaa ainoastaan sovellusta kehitettäessä, asennetaan <i>jest</i> kehitysaikaiseksi riippuvuudeksi komennolla</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev jest</code></pre></div>
<p>määritellään <i>npm skripti _test</i> suorittamaan testaus jestillä ja raportoimaan testien suorituksesta <i>verbose</i>-tyylillä:</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash"><span class="token punctuation">{</span>
  //<span class="token punctuation">..</span>.
  <span class="token string">&quot;scripts&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;start&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;node index.js&quot;</span>,
    <span class="token string">&quot;watch&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;nodemon index.js&quot;</span>,
    <span class="token string">&quot;lint&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;eslint .&quot;</span>,
    <span class="token string">&quot;test&quot;</span><span class="token keyword">:</span> <span class="token string">&quot;jest --verbose&quot;</span>
  <span class="token punctuation">}</span>,
  //<span class="token punctuation">..</span>.
<span class="token punctuation">}</span></code></pre></div>
<p>Jestin uudemmissa versioissa näyttäisi olevan tarve kertoa, että suoritusympäristönä on käytössä Node. Tämä tapahtuu esim. lisäämällä <i>package.json</i> tiedoston loppuun:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token punctuation">{</span>
 <span class="token comment">//...</span>
 <span class="token string">&quot;jest&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
   <span class="token string">&quot;testEnvironment&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;node&quot;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Tai vaihtoehtoisesti Jest löytää myös oletuksena asetustiedoston nimellä <i>jest.config.js</i>, jonne suoritusympäristön määrittely tapahtuu seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  testEnvironment<span class="token punctuation">:</span> <span class="token string">&#x27;node&#x27;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Tehdään testejä varten hakemisto <i>tests</i> ja sinne tiedosto <i>palindrom.test.js</i>, jonka sisältö on seuraava</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> palindrom <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../utils/for_testing&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>palindrom

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;palindrom of a&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">palindrom</span><span class="token punctuation">(</span><span class="token string">&#x27;a&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;a&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;palindrom of react&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">palindrom</span><span class="token punctuation">(</span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;tcaer&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;palindrom of saippuakauppias&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">palindrom</span><span class="token punctuation">(</span><span class="token string">&#x27;saippuakauppias&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;saippuakauppias&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Edellisessä osassa käyttöön ottamamme ESlint valittaa testien käyttämistä komennoista <em>test</em> ja <em>expect</em> sillä käyttämämme konfiguraatio kieltää <i>globaalina</i> määriteltyjen asioiden käytön. Poistetaan valitus lisäämällä <i>.eslintrc.js</i>-tiedoston kenttään <i>env</i> arvo <i>&quot;jest&quot;: true</i>. Näin kerromme eslintille, että käytämme projektissamme Jestiä ja sen globaaleja muuttujia.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;env&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;es6&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">&quot;node&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">&quot;jest&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;extends&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;eslint:recommended&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;rules&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></div>
<p>Testi ottaa ensimmäisellä rivillä käyttöön testattavan funktion sijoittaen sen muuttujaan <em>palindrom</em>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> palindrom <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../utils/for_testing&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>palindrom</code></pre></div>
<p>Yksittäiset testitapaukset määritellään funktion <em>test</em> avulla. Ensimmäisenä parametrina on merkkijonomuotoinen testin kuvaus. Toisena parametrina on <i>funktio</i>, joka määrittelee testitapauksen toiminnallisuuden. Esim. toisen testitapauksen toiminnallisuus näyttää seuraavalta:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">palindrom</span><span class="token punctuation">(</span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;tcaer&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Ensin suoritetaan testattava koodi, eli generoidaan merkkijonon <i>react</i> palindromi. Seuraavaksi varmistetaan tulos metodin <a href="https://facebook.github.io/jest/docs/en/expect.html#content">expect</a> avulla. Expect käärii tuloksena olevan arvon olioon, joka tarjoaa joukon <i>matcher</i>-funktioita, joiden avulla tuloksen oikeellisuutta voidaan tarkastella. Koska kyse on kahden merkkijonon samuuden vertailusta, sopii tilanteeseen matcheri <a href="https://facebook.github.io/jest/docs/en/expect.html#tobevalue">toBe</a>.</p>
<p>Kuten odotettua, testit menevät läpi:</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/03a306005b711bf48ab85efb74524f87/14be6/1.png"/></picture>
<p>Jest olettaa oletusarvoisesti, että testitiedoston nimessä on merkkijono <i>.test</i>. Käytetään kurssilla konventiota, millä testitiedostojen nimen loppu on <i>.test.js</i></p>
<p>Jestin antamat virheilmoitukset ovat hyviä, rikotaan testi</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;palindrom of react&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">palindrom</span><span class="token punctuation">(</span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;tkaer&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>seurauksena on seuraava virheilmotus</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/c156474ebaa7f5f8af5cd036dcc36762/14be6/2.png"/></picture>
<p>Lisätään muutama testi metodille <em>average</em>, tiedostoon <i>tests/average.test.js</i>.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> average <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../utils/for_testing&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>average

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;average&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;of one value is the value itself&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;of many is calculated right&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3.5</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;of empty array is zero&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Testi paljastaa, että metodi toimii väärin tyhjällä taulukolla (sillä nollallajaon tulos on Javascriptissä <i>NaN</i>):</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/db28500e50ec92eca13aba8de8e5ddbf/14be6/3.png"/></picture>
<p>Metodi on helppo korjata</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">average</span> <span class="token operator">=</span> array <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>sum<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sum <span class="token operator">+</span> item
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> array<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span>
    <span class="token operator">?</span> <span class="token number">0</span> 
    <span class="token punctuation">:</span> array<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> array<span class="token punctuation">.</span>length
<span class="token punctuation">}</span></code></pre></div>
<p>Eli jos taulukon pituus on 0, palautetaan 0 ja muussa tapauksessa palautetaan metodin <em>reduce</em> avulla laskettu keskiarvo.</p>
<p>Pari huomiota keskiarvon testeistä. Määrittelimme testien ympärille nimellä <em>average</em> varustetun <i>describe</i>-lohkon.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;average&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// testit</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Describejen avulla yksittäisessä tiedostossa olevat testit voidaan jaotella loogisiin kokonaisuuksiin. Testituloste hyödyntää myös describe-lohkon nimeä:</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/004954133431038eae2beda821cec5d7/14be6/4.png"/></picture>
<p>Kuten myöhemmin tulemme näkemään, <i>describe</i>-lohkot ovat tarpeellisia siinä vaiheessa, jos haluamme osalle yksittäisen testitiedoston testitapauksista jotain yhteisiä alustus- tai lopetustoimenpiteitä.</p>
<p>Toisena huomiona se, että kirjoitimme testit aavistuksen tiiviimmässä muodossa, ottamatta testattavan metodin tulosta erikseen apumuuttujaan:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;of empty array is zero&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">average</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
</div></div>
<div class="banner spacing spacing--after tasks" style="background-color:#F7F382"><div class="container"><div class="course-content col-6 push-right-3" style="border-color:#F7F382">
<h3>Tehtäviä</h3>
<p>Tehdään joukko blogilistan käsittelyyn tarkoitettuja apufunktioita. Tee funktiot esim. tiedostoon <i>utils/list_helper.js</i>. Tee testit sopivasti nimettyyn tiedostoon hakemistoon <i>tests</i>.</p>
<h4>4.3: apufunktioita ja yksikkötestejä, osa 1</h4>
<p>Määrittele ensin funktio <em>dummy</em> joka saa parametrikseen taulukollisen blogeja ja palauttaa aina luvun 1. Tiedoston <i>list_helper.js</i> sisällöksi siis tulee tässä vaiheessa</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">dummy</span> <span class="token operator">=</span> <span class="token punctuation">(</span>blogs<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  dummy
<span class="token punctuation">}</span></code></pre></div>
<p>Varmista testikonfiguraatiosi toimivuus seuraavalla testillä:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> listHelper <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../utils/list_helper&#x27;</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;dummy returns one&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> blogs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">const</span> result <span class="token operator">=</span> listHelper<span class="token punctuation">.</span><span class="token function">dummy</span><span class="token punctuation">(</span>blogs<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h4>4.4: apufunktioita ja yksikkötestejä, osa 2</h4>
<p>Määrittele funktio <em>totalLikes</em> joka saa parametrikseen taulukollisen blogeja. Funktio palauttaa blogien yhteenlaskettujen tykkäysten eli <i>likejen</i> määrän.</p>
<p>Määrittele funktiolle sopivat testit. Funktion testit kannattaa laittaa <i>describe</i>-lohkoon jolloin testien tulostus ryhmittyy miellyttävästi:</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/56229b0710f038d818828ad82ff10bfd/14be6/5.png"/></picture>
<p>Testisyötteiden määrittely onnistuu esim. seuraavaan tapaan:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;total likes&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> listWithOneBlog <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      _id<span class="token punctuation">:</span> <span class="token string">&#x27;5a422aa71b54a676234d17f8&#x27;</span><span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> <span class="token string">&#x27;Go To Statement Considered Harmful&#x27;</span><span class="token punctuation">,</span>
      author<span class="token punctuation">:</span> <span class="token string">&#x27;Edsger W. Dijkstra&#x27;</span><span class="token punctuation">,</span>
      url<span class="token punctuation">:</span> <span class="token string">&#x27;http://www.u.arizona.edu/~rubinson/copyright_violations/Go_To_Considered_Harmful.html&#x27;</span><span class="token punctuation">,</span>
      likes<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      __v<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;when list has only one blog equals the likes of that&#x27;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> listHelper<span class="token punctuation">.</span><span class="token function">totalLikes</span><span class="token punctuation">(</span>listWithOneBlog<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Jos et viitsi itse määritellä testisyötteenä käytettäviä blogeja, saat valmiin listan <a href="https://github.com/fullstack-hy2019/misc/blob/master/blogs_for_test.md">täältä</a></p>
<p>Törmäät varmasti testien tekemisen yhteydessä erinäisiin ongelmiin. Pidä mielessä osassa 3 käsitellyt <a href="osa3/tietojen_tallettaminen_mongo_db_tietokantaan#node-sovellusten-debuggaaminen">debuggaukseen</a> liittyvät asiat, voit testejäkin suorittaessasi printtailla konsoliin komennolla <em>console.log</em>. Myös debuggerin käyttö testejä suorittaessa on mahdollista, ohje <a href="https://jestjs.io/docs/en/troubleshooting">täällä</a>.</p>
<p><strong>HUOM:</strong> jos jokin testi ei mene läpi, ei ongelmaa korjatessa kannata suorittaa kaikkia testejä, vaan ainoastaan rikkinäistä testiä hyödyntäen <a href="https://facebook.github.io/jest/docs/en/api.html#testonlyname-fn-timeout">only</a>-metodia. </p>
<p>Toinen, tapa suorittaa yksittäinen testi (tai describe-lohko) on kutsua jestiä suoraan ja määritellä sille suoritettava testi argumentin <a href="https://jestjs.io/docs/en/cli.html">-t</a> avulla:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">npx jest <span class="token operator">-</span>t <span class="token string">&#x27;when list has only one blog equals the likes of that&#x27;</span></code></pre></div>
<h4>4.5*: apufunktioita ja yksikkötestejä, osa 3</h4>
<p>Määrittele funktio <em>favoriteBlog</em> joka saa parametrikseen taulukollisen blogeja. Funktio selvittää millä blogilla on eniten likejä. Jos suosikkeja on monta, riittää että funktio palauttaa niistä jonkun.</p>
<p>Paluuarvo voi olla esim. seuraavassa muodossa:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token punctuation">{</span>
  title<span class="token punctuation">:</span> <span class="token string">&quot;Canonical string reduction&quot;</span><span class="token punctuation">,</span>
  author<span class="token punctuation">:</span> <span class="token string">&quot;Edsger W. Dijkstra&quot;</span><span class="token punctuation">,</span>
  likes<span class="token punctuation">:</span> <span class="token number">12</span>
<span class="token punctuation">}</span></code></pre></div>
<p><strong>Huom</strong>, että kun vertailet olioita, metodi <a href="https://jestjs.io/docs/en/expect#toequalvalue">toEqual</a> on todennäköisesti se mitä haluat käyttää sillä <a href="https://jestjs.io/docs/en/expect#tobevalue">toBe</a>-vertailu, joka sopii esim. lukujen ja merkkijonojen vertailuun vaatisi olioiden vertailussa, että oliot ovat samat, pelkkä sama sisältöisyys ei riitä.</p>
<p>Tee myös tämän ja seuraavien kohtien testit kukin oman <i>describe</i>-lohkon sisälle.</p>
<h4>4.6*: apufunktioita ja yksikkötestejä, osa 4</h4>
<p>Tämä ja seuraava tehtävä ovat jo hieman haastavampia. Tehtävien tekeminen ei ole osan jatkon kannalta oleellista, eli voi olla hyvä idea palata näihin vasta kun muu osa on kahlattu läpi.</p>
<p>Tehtävän tekeminen onnistuu hyvin ilman mitään kirjastojakin, mutta tämä saattaa olla hyvä paikka tutustua kokoelmien käsittelyä suuresti helpottavaan <a href="https://lodash.com/">Lodash</a>-kirjastoon.</p>
<p>Määrittele funktio <em>mostBlogs</em> joka saa parametrikseen taulukollisen blogeja. Funktio selvittää <i>kirjoittajan</i>, kenellä on eniten blogeja. Funktion paluuarvo kertoo myös ennätysblogaajan blogien määrän:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token punctuation">{</span>
  author<span class="token punctuation">:</span> <span class="token string">&quot;Robert C. Martin&quot;</span><span class="token punctuation">,</span>
  blogs<span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Jos ennätysblogaajia on monta, riittää että funktio palauttaa niistä jonkun.</p>
<h4>4.7*: apufunktioita ja yksikkötestejä, osa 5</h4>
<p>Määrittele funktio <em>mostLikes</em> joka saa parametrikseen taulukollisen blogeja. Funktio selvittää kirjoittajan, kenen blogeilla on eniten likejä. Funktion paluuarvo kertoo myös suosikkiblogaajan likejen yhteenlasketun määrän:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token punctuation">{</span>
  author<span class="token punctuation">:</span> <span class="token string">&quot;Edsger W. Dijkstra&quot;</span><span class="token punctuation">,</span>
  likes<span class="token punctuation">:</span> <span class="token number">17</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Jos suosikkiblogaajia on monta, riittää että funktio palauttaa niistä jonkun.</p>
</div></div></div>
<div class="container"><div class="course-content col-6 push-right-3">
<h3>Backendin testaaminen</h3>
<p>Ruvetaan nyt tekemään testejä backendille. Koska backend ei sisällä monimutkaista laskentaa, ei yksittäisiä funktioita testaavia <a href="https://en.wikipedia.org/wiki/Unit_testing">yksikkötestejä</a> oikeastaan kannata tehdä. Ainoa potentiaalinen yksikkötestattava asia olisi muistiinpanojen metodi <em>toJSON</em>. </p>
<p>Joissain tilanteissa voisi olla mielekästä suorittaa ainakin osa backendin testauksesta siten, että oikea tietokanta eristettäisiin testeistä ja korvattaisiin &quot;valekomponentilla&quot; eli mockilla. Eräs tähän sopiva ratkaisu olisi <a href="https://github.com/williamkapke/mongo-mock">mongo-mock</a>.</p>
<p>Koska sovelluksemme backend on koodiltaan kuitenkin suhteellisen yksinkertainen, päätämme testata sitä kokonaisuudessaan, siten että myös testeissä käytetään tietokantaa. Tämän kaltaisia, useita sovelluksen komponentteja yhtäaikaa käyttäviä testejä voi luonnehtia <a href="https://en.wikipedia.org/wiki/Integration_testing">integraatiotesteiksi</a>.</p>
<h3>test-ympäristö</h3>
<p>Edellisen osan luvussa <a href="/osa3/validointi_ja_es_lint#tietokantaa-kayttavan-version-vieminen-tuotantoon">Tietokantaa käyttävän version vieminen tuotantoon</a> mainitsimme, että kun sovellusta suoritetaan Herokussa, on se <i>production</i>-moodissa.</p>
<p>Noden konventiona on määritellä projektin suoritusmoodi ympäristömuuttujan <i>NODE_ENV</i> avulla. Lataammekin sovelluksen nykyisessä versiossa tiedostossa <i>.env</i> määritellyt ympäristömuuttujat ainoastaan jos sovellus <i>ei ole</i> production moodissa:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#x27;production&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;dotenv&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Yleinen käytäntö on määritellä sovelluksille omat moodinsa myös sovelluskehitykseen ja testaukseen.</p>
<p>Määritellään nyt tiedostossa <i>package.json</i>, että testejä suorittaessa sovelluksen <i>NODE_ENV</i> saa arvokseen <i>test</i>:</p>
<div class="gatsby-highlight" data-language="json"><pre><code class="language-json"><span class="token punctuation">{</span>
  // ...
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=production node index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=development nodemon index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;NODE_ENV=test jest --verbose --runInBand&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint .&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  // ...
<span class="token punctuation">}</span></code></pre></div>
<p>Lisäsimme testit suorittavaan npm-skriptiin myös määreen <a href="https://jestjs.io/docs/en/cli.html#runinband">runInBand</a> joka estää testien rinnakkaisen suorituksen. Tämä tarkennus on viisainta tehdä kun testimme tulevat käyttämään tietokantaa.</p>
<p>Samalla määriteltiin, että suoritettaessa sovellusta komennolla <em>npm run watch</em> eli nodemonin avulla, on sovelluksen moodi <i>development</i>. Jos sovellusta suoritetaan normaalisti Nodella, on moodiksi määritelty <i>production</i>.</p>
<p>Määrittelyssämme on kuitenkin pieni ongelma, se ei toimi windowsilla. Tilanne korjautuu asentamalla kirjasto <a href="https://www.npmjs.com/package/cross-env">cross-env</a> komennolla</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev cross-env</code></pre></div>
<p>ja muuttamalla <i>package.js</i> kaikilla käyttöjärjestelmillä toimivaan muotoon</p>
<div class="gatsby-highlight" data-language="json"><pre><code class="language-json"><span class="token punctuation">{</span>
  // ...
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production node index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;watch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=development nodemon index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=test jest --verbose --runInBand&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;lint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;eslint .&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  // ...
<span class="token punctuation">}</span></code></pre></div>
<p>Nyt sovelluksen toimintaa on mahdollista muokata sen suoritusmoodiin perustuen. Eli voimme määritellä, esim. että testejä suoritettaessa ohjelma käyttää erillistä, testejä varten luotua tietokantaa.</p>
<p>Sovelluksen testikanta voidaan luoda tuotantokäytön ja sovelluskehityksen tapaan <a href="https://mlab.com/">mlabiin</a>. Ratkaisu ei ole optimaalinen erityisesti, jos sovellusta on tekemässä yhtä aikaa useita henkilöitä. Testien suoritus nimittäin yleensä edellyttää, että samaa tietokantainstanssia ei ole yhtä aikaa käyttämässä useampia testiajoja.</p>
<p>Testaukseen kannattaakin käyttää verkossa olevaa jaettua tietokantaa mieluummin esim. sovelluskehittäjän paikallisen koneen tietokantaa. Optimiratkaisu olisi tietysti se, että jokaista testiajoa varten olisi käytettävissä oma tietokanta, sekin periaatteessa onnistuu &quot;suhteellisen helposti&quot; mm. <a href="https://docs.mongodb.com/manual/core/inmemory/">keskusmuistissa toimivan Mongon</a> ja <a href="https://www.docker.com">docker</a>-kontainereiden avulla. Etenemme kuitenkin nyt lyhyemmän kaavan mukaan ja käytetään testikantana normaalia Mongoa.</p>
<p>Muutetaan konfiguraatiot suorittavaa moduulia seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#x27;production&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;dotenv&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span>
<span class="token keyword">let</span> mongoUrl <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span>

<span class="gatsby-highlight-code-line"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">  mongoUrl <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">TEST_MONGODB_URI</span></span><span class="gatsby-highlight-code-line"><span class="token punctuation">}</span></span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mongoUrl<span class="token punctuation">,</span>
  port<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Koodi siis lataa ympäristömuuttujat tiedostosta <i>.env</i> jos se <i>ei ole</i> tuotantomoodissa. Tuotantomoodissa käytetään Herokuun asetettuja ympäristömuuttujia.</p>
<p>Tiedostossa <i>.env</i> on nyt määritelty <i>erikseen</i> sekä sovelluskehitysympäristön että testausympäristön tietokannan osoite (esimerkissä molemmat ovat sovelluskehityskoneen lokaaleja mongo-kantoja):</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash">MONGODB_URI<span class="token operator">=</span>mongodb://fullstack:secred@ds161224.mlab.com:61224/fullstack2019-notes
PORT<span class="token operator">=</span>3001

<span class="gatsby-highlight-code-line">TEST_MONGODB_URI<span class="token operator">=</span>mongodb://fullstack:secred@ds163054.mlab.com:63054/fullstack2019-notes-test</span></code></pre></div>
<p>Omatekemämme eri ympäristöjen konfiguroinnista huolehtiva <em>config</em>-moduuli toimii hieman samassa hengessä kuin <a href="https://github.com/lorenwest/node-config">node-config</a>-kirjasto. Omatekemä konfigurointiympäristö sopii tarkoitukseemme, sillä sovellus on yksinkertainen ja oman konfiguraatio-moduulin tekeminen on myös jossain määrin opettavaista. Isommissa sovelluksissa kannattaa harkita valmiiden kirjastojen, kuten <a href="https://github.com/lorenwest/node-config">node-config</a>:in käyttöä.</p>
<p>Muualle koodiin ei muutoksia tarvita.</p>
<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/fullstack-hy2019/part3-notes-backend/tree/part4-2">githubissa</a>, branchissä <i>part4-2</i>.</p>
<h3>supertest</h3>
<p>Käytetään API:n testaamiseen Jestin apuna <a href="https://github.com/visionmedia/supertest">supertest</a>-kirjastoa.</p>
<p>Kirjasto asennetaan kehitysaikaiseksi riippuvuudeksi komennolla</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev supertest</code></pre></div>
<p>Luodaan heti ensimmäinen testi tiedostoon <i>tests/note_api.test.js</i></p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;supertest&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../app&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;notes are returned as json&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Testi importtaa tiedostoon <i>app.js</i> määritellyn Express-sovelluksen ja käärii sen  funktion <i>supertest</i> avulla ns. <a href="https://github.com/visionmedia/superagent">superagent</a>-olioksi. Tämä olio sijoitetaan muuttujaan <i>api</i> ja sen kautta testit voivat tehdä HTTP-pyyntöjä backendiin.</p>
<p>Testimetodi tekee HTTP GET -pyynnön osoitteeseen <i>api/notes</i> ja varmistaa, että pyyntöön vastataan statuskoodilla 200 ja että data palautetaan oikeassa muodossa, eli että <i>Content-Type</i>:n arvo on <i>application/json</i>.</p>
<p>Testissä on muutama detalji joihin tutustumme vasta <a href="#async-await">hieman myöhemmin</a> tässä osassa. Testikoodin määrittelevä nuolifunktio alkaa sanalla <i>async</i> ja <i>api</i>-oliolle tehtyä metodikutsua edeltää sama <i>await</i>. Teemme ensin muutamia testejä ja tutustumme sen jälkeen async/await-magiaan. Tällä hetkellä niistä ei tarvitse välittää, kaikki toimii kun kirjoitat testimetodit esimerkin mukaan. Async/await-syntaksin käyttö liittyy siihen, että palvelimelle tehtävät pyynnöt ovat <i>asynkronisia</i> operaatioita. <a href="https://facebook.github.io/jest/docs/en/asynchronous.html">Async/await-kikalla</a> saamme pyynnön näyttämään koodin tasolla synkroonisesti toimivalta.</p>
<p>Kaikkien testien (joita siis tällä kertaa on vain yksi) päätteeksi on vielä lopputoimenpiteenä katkaistava mongoosen käyttämä tietokantayhteys. Tämä onnistuu helposti metodissa <a href="https://facebook.github.io/jest/docs/en/api.html#afterallfn-timeout">afterAll</a>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Pieni mutta tärkeä huomio: eristimme tämän osan <a href="http://localhost:8000/osa4/sovelluksen_rakenne_ja_testauksen_alkeet#sovelluksen-rakenne">alussa</a> Express-sovelluksen tiedostoon <i>app.js</i> ja tiedoston <i>index.js</i> rooliksi jäi sovelluksen käynnistäminen määriteltyyn porttiin Noden <i>http</i>-olion avulla:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./app&#x27;</span><span class="token punctuation">)</span> <span class="token comment">// varsinainen Express-sovellus</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;http&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./utils/config&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Server running on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Testit käyttävät ainoastaan tiedostossa <i>app.js</i> määriteltyä express-sovellusta:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;supertest&#x27;</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../app&#x27;</span><span class="token punctuation">)</span></span>
<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span></span>
<span class="token comment">// ...</span></code></pre></div>
<p>Supertestin dokumentaatio toteaa seuraavasti</p>
<blockquote>
<p><i>if the server is not already listening for connections then it is bound to an ephemeral port for you so there is no need to keep track of ports.</i></p>
</blockquote>
<p>eli Supertest huolehtii testattavan sovelluksen käynnistämisestä sisäisesti käyttämäänsä porttiin.</p>
<p>Tehdään pari testiä lisää:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;there are five notes&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;the first note is about HTTP methods&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">&#x27;HTML on helppoa&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Molemmat testit sijoittavat pyynnön vastauksen muuttujaan <em>response</em> ja toisin kuin edellinen testi, joka käytti <em>supertestin</em> mekanismeja statuskoodin ja vastauksen headereiden oikeellisuuden varmistamiseen, tällä kertaa tutkitaan vastauksessa olevan datan, eli <i>response.body</i>:n oikeellisuutta Jestin <a href="https://facebook.github.io/jest/docs/en/expect.html#content">expect</a>:in avulla.</p>
<p>Async/await-kikan hyödyt tulevat nyt selkeästi esiin. Normaalisti tarvitsisimme asynkronisten pyyntöjen vastauksiin käsille pääsemiseen promiseja ja takaisinkutsuja, mutta nyt kaikki menee mukavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

<span class="token comment">// tänne tullaan vasta kun edellinen komento eli HTTP-pyyntö on suoritettu</span>
<span class="token comment">// muuttujassa res on nyt HTTP-pyynnön tulos</span>
<span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre></div>
<h3>Loggeri</h3>
<p>HTTP-pyyntöjen tiedot konsoliin kirjoittava middleware häiritsee hiukan testien tulostusta. Konsoliin tulostaminen onkin viisainta estää silloin kuin sovellus on testausmoodissa. Eristetään samalla kaikki konsoliin tulostelu omaan moduliinsa <i>utils/logger.js</i>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">info</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>params<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">&#x27;test&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token operator">...</span>params<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">...</span>params<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token operator">...</span>params<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  info<span class="token punctuation">,</span> error
<span class="token punctuation">}</span></code></pre></div>
<p>Loggeri tarjoaa kaksi funktiota, joista <em>info</em> ei tulosta mitään sovelluksen ollessa testausmoodissa. Virhetilanteisiin tarkoitettu funktio <em>error</em> tulostaa konsoliin myös testausmoodissa.</p>
<p>Otetaan loggeri käyttöön muualla sovelluksessa. Muutoksia tulee middlewaret määrittelevään tiedostoon</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./logger&#x27;</span><span class="token punctuation">)</span></span>
<span class="token keyword">const</span> <span class="token function-variable function">requestLogger</span> <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#x27;Method:&#x27;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>method<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#x27;Path:  &#x27;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>path<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#x27;Body:  &#x27;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>body<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#x27;---&#x27;</span><span class="token punctuation">)</span></span>  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">unknownEndpoint</span> <span class="token operator">=</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">&#x27;unknown endpoint&#x27;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">errorHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#x27;CastError&#x27;</span> <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>kind <span class="token operator">===</span> <span class="token string">&#x27;ObjectId&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">&#x27;malformatted id&#x27;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&#x27;ValidationError&#x27;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> error<span class="token punctuation">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">next</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  requestLogger<span class="token punctuation">,</span>
  unknownEndpoint<span class="token punctuation">,</span>
  errorHandler
<span class="token punctuation">}</span></code></pre></div>
<p>ja express-sovelluksen määrittelevään tiedostoon <i>app.js</i>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token comment">// ...</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./utils/logger&#x27;</span><span class="token punctuation">)</span></span>
<span class="gatsby-highlight-code-line">logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#x27;connecting to&#x27;</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span><span class="token punctuation">)</span></span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">MONGODB_URI</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&#x27;connected to MongoDB&#x27;</span><span class="token punctuation">)</span></span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#x27;error connection to MongoDB:&#x27;</span><span class="token punctuation">,</span> error<span class="token punctuation">.</span>message<span class="token punctuation">)</span></span>  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span></code></pre></div>
<p>Logauksen eristäminen omaan moduulinsa vastuulle on monellakin tapaa järkevää. Jos esim. päätämme ruveta kirjoittamaan logeja tiedostoon tai keräämään ne johonkin ulkoiseen palveuun kuten <a href="https://www.graylog.org/">graylog</a> tai <a href="https://papertrailapp.com">papertrail</a>, on muutos helppo tehdä yhteen paikkaan.</p>
<h3>Tietokannan alustaminen ennen testejä</h3>
<p>Testaus vaikuttaa helpolta ja testit menevät läpi. Testimme ovat kuitenkin huonoja, niiden läpimeno riippuu tietokannan tilasta (joka sattuu omassa testikannassani olemaan sopiva). Jotta saisimme robustimmat testit, tulee tietokannan tila nollata testien alussa ja sen jälkeen laittaa kantaan hallitusti testien tarvitsema data.</p>
<p>Testimme käyttää jo jestin metodia <a href="https://facebook.github.io/jest/docs/en/api.html#afterallfn-timeout">afterAll</a> sulkemaan backendin testien suoritusten jälkeen. Jest tarjoaa joukon muitakin <a href="https://facebook.github.io/jest/docs/en/setup-teardown.html#content">funktioita</a>, joiden avulla voidaan suorittaa operaatioita ennen yhdenkään testin suorittamista tai ennen jokaisen testin suoritusta.</p>
<p>Päätetään alustaa tietokanta ennen <i>jokaisen testin suoritusta,</i> eli funktiossa <a href="https://jestjs.io/docs/en/api.html#aftereachfn-timeout">beforeEach</a>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;supertest&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> server <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../index&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
<span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../models/note&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> initialNotes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">&#x27;HTML on helppoa&#x27;</span><span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">&#x27;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&#x27;</span><span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Tietokanta siis tyhjennetään aluksi ja sen jälkeen kantaan lisätään kaksi taulukkoon <em>initialNotes</em> talletettua muistiinpanoa. Näin testien suoritus aloitetaan aina hallitusti samasta tilasta.</p>
<p>Muutetaan kahta jälkimmäistä testiä vielä seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;all notes are returned&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

<span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a specific note is within the returned notes&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> contents <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span>
  <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">    <span class="token string">&#x27;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&#x27;</span></span>  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Huomaa jälkimmäisen testin ekspektaatio. Komennolla <code>response.body.map(r =&gt; r.content)</code> muodostetaan taulukko API:n palauttamien muistiinpanojen sisällöistä. Jestin <a href="https://facebook.github.io/jest/docs/en/expect.html#tocontainitem">toContain</a>-ekspektaatiometodilla tarkistetaan että parametrina oleva muistiinpano on kaikkien API:n palauttamien muistiinpanojen joukossa.</p>
<h3>Testien suorittaminen yksitellen</h3>
<p>Komento <em>npm test</em> suorittaa projektin kaikki testit. Kun olemme vasta tekemässä testejä, on useimmiten järkevämpää suorittaa kerrallaan ainoastaan yhtä tai muutamaa testiä. Jest tarjoaa tähän muutamia vaihtoehtoja. Eräs näistä on komennon <a href="https://jestjs.io/docs/en/api#testonlyname-fn-timeout">only</a> käyttö. Jos testit on kirjoitettu useaan tiedotoon, ei menetelmä ole kovin hyvä.</p>
<p>Parempi vaihtoehto on käyttää jestiä suoraan, ilman npm:ää. Tällöin on mahdollista määritellä tarkasti mitä testejä jest suorittaa. Seuraava komento suorittaa ainoastaan tiedostossa <i>tests/note_api.test.js</i> olevat testit</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">npx est tests<span class="token operator">/</span>note_api<span class="token punctuation">.</span>test<span class="token punctuation">.</span>js <span class="token operator">--</span>runInBand</code></pre></div>
<p>Parametrin <i>-t</i> avulla voidaan suorittaa testejä nimen perusteella:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">npx jest <span class="token operator">-</span>t <span class="token string">&#x27;a specific note is within the returned notes&#x27;</span></code></pre></div>
<p>Parametri voi viitata testin tai describe-lohkon nimeen. Parametrina voidaan antaa myös nimen osa. Seuraava komento suorittaisi kaikki testit, joiden nimessä on sana <i>notes</i>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">npx jest <span class="token operator">-</span>t <span class="token string">&#x27;notes&#x27;</span> <span class="token operator">--</span>runInBand</code></pre></div>
<p>Jos asennat koneellesi jestin <i>globaalisti</i>, eli komennolla</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">npm install <span class="token operator">-</span>g jest</code></pre></div>
<p>testien suoritus onnistuu suoraan komennolla <em>jest</em>. Globaaliin asennukseen tarvitset pääkäyttäjän oikeudet.</p>
<h3>async-await</h3>
<p>Ennen kuin teemme lisää testejä, tarkastellaan tarkemmin mitä <em>async</em> ja <em>await</em> tarkoittavat.</p>
<p>Async- ja await ovat ES7:n mukanaan tuoma uusi syntaksi, joka mahdollistaa <i>promisen palauttavien asynkronisten funktioiden</i> kutsumisen siten, että kirjoitettava koodi näyttää synkroniselta.</p>
<p>Esim. muistiinpanojen hakeminen tietokannasta hoidetaan promisejen avulla seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>notes <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;operaatio palautti seuraavat muistiinpanot&#x27;</span><span class="token punctuation">,</span> notes<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Metodikutsu <em>Note.find()</em> palauttaa promisen, ja saamme itse operaation tuloksen rekisteröimällä promiselle tapahtumankäsittelijän metodilla <em>then</em>.</p>
<p>Kaikki operaation suorituksen jälkeinen koodi kirjoitetaan tapahtumankäsittelijään. Jos haluaisimme tehdä peräkkäin useita asynkronisia funktiokutsuja, menisi tilanne ikävämmäksi. Joutuisimme tekemään kutsut tapahtumankäsittelijästä. Näin syntyisi potentiaalisesti monimutkaista koodia, pahimmassa tapauksessa jopa niin sanottu <a href="http://callbackhell.com/">callback-helvetti</a>.</p>
<p><a href="https://javascript.info/promise-chaining">Ketjuttamalla promiseja</a> tilanne pysyy jollain tavalla hallinnassa, callback-helvetin eli monien sisäkkäisten callbackien sijaan saadaan aikaan siistihkö <em>then</em>-kutsujen ketju. Olemmekin nähneet jo kurssin aikana muutaman sellaisen. Seuraavassa vielä erittäin keinotekoinen esimerkki, joka hakee ensin kaikki muistiinpanot ja sitten tuhoaa niistä ensimmäisen:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>notes <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> notes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;the first note is removed&#x27;</span><span class="token punctuation">)</span>
    <span class="token comment">// more code here</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Then-ketju on ok, mutta parempaankin pystytään. Jo ES6:ssa esitellyt <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator">generaattorifunktiot</a> mahdollistivat <a href="https://github.com/getify/You-Dont-Know-JS/blob/master/async%20%26%20performance/ch4.md#iterating-generators-asynchronously">ovelan tavan</a> määritellä asynkronista koodia siten että se &quot;näyttää synkroniselta&quot;. Syntaksi ei kuitenkaan ole täysin luonteva ja sitä ei käytetä kovin yleisesti.</p>
<p>ES7:ssa <em>async</em> ja <em>await</em> tuovat generaattoreiden tarjoaman toiminnallisuuden ymmärrettävästi ja syntaksin puolesta selkeällä tavalla koko Javascript-kansan ulottuville.</p>
<p>Voisimme hakea tietokannasta kaikki muistiinpanot <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await">await</a>-operaattoria hyödyntäen seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;operaatio palautti seuraavat muistiinpanot &#x27;</span><span class="token punctuation">,</span> notes<span class="token punctuation">)</span></code></pre></div>
<p>Koodi siis näyttää täsmälleen synkroniselta koodilta. Suoritettavan koodinpätkän suhteen tilanne on se, että suoritus pysähtyy komentoon <em>const notes = await Note.find({})</em> ja jatkuu kyselyä vastaavan promisen <i>fulfillmentin</i> eli onnistuneen suorituksen jälkeen seuraavalta riviltä. Kun suoritus jatkuu, promisea vastaavan operaation tulos on muuttujassa <em>notes</em>.</p>
<p>Ylempänä oleva monimutkaisempi esimerkki suoritettaisiin awaitin avulla seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> notes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;the first note is removed&#x27;</span><span class="token punctuation">)</span></code></pre></div>
<p>Koodi siis yksinkertaistuu huomattavasti verrattuna promiseja käyttävään then-ketjuun.</p>
<p>Awaitin käyttöön liittyy parikin tärkeää seikkaa. Jotta asynkronisia operaatioita voi kutsua awaitin avulla, niiden täytyy palauttaa promiseja. Tämä ei sinänsä ole ongelma, sillä myös &quot;normaaleja&quot; callbackeja käyttävä asynkroninen koodi on helppo kääriä promiseksi.</p>
<p>Mistä tahansa kohtaa Javascript-koodia ei awaitia kuitenkaan pysty käyttämään. Awaitin käyttö onnistuu ainoastaan jos ollaan <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">async</a>-funktiossa.</p>
<p>Eli jotta edelliset esimerkit toimisivat, on ne suoritettava async-funktioiden sisällä, huomaa funktion määrittelevä rivi:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> main <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;operaatio palautti seuraavat muistiinpanot&#x27;</span><span class="token punctuation">,</span> notes<span class="token punctuation">)</span>

  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> notes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;the first note is removed&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line"><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></code></pre></div>
<p>Koodi määrittelee ensin asynkronisen funktion, joka sijoitetaan muuttujaan <em>main</em>. Määrittelyn jälkeen koodi kutsuu metodia komennolla <code>main()</code></p>
<h3>async/await backendissä</h3>
<p>Muutetaan nyt backend käyttämään asyncia ja awaitia. Koska kaikki asynkroniset operaatiot tehdään joka tapauksessa funktioiden sisällä, awaitin käyttämiseen riittää, että muutamme routejen käsittelijät async-funktioiksi.</p>
<p>Kaikkien muistiinpanojen hakemisesta vastaava route muuttuu seuraavasti:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">notesRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> note<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Voimme varmistaa refaktoroinnin onnistumisen selaimella, sekä suorittamalla juuri määrittelemämme testit.</p>
<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/fullstack-hy2019/part3-notes-backend/tree/part4-3">githubissa</a>, branchissa <i>part4-3</i>.</p>
<h3>Lisää testejä ja backendin refaktorointia</h3>
<p>Koodia refaktoroidessa vaanii aina <a href="https://en.wikipedia.org/wiki/Regression_testing">regression</a> vaara, eli on olemassa riski, että jo toimineet ominaisuudet hajoavat. Tehdäänkin muiden operaatioiden refaktorointi siten, että ennen koodin muutosta tehdään jokaiselle API:n routelle sen toiminnallisuuden varmistavat testit.</p>
<p>Aloitetaan lisäysoperaatiosta. Tehdään testi, joka lisää uuden muistiinpanon ja tarkistaa, että API:n palauttamien muistiinpanojen määrä kasvaa, ja että lisätty muistiinpano on palautettujen joukossa:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a valid note can be added &#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">&#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;</span><span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> contents <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Kuten odotimme ja toivoimme, menee testi läpi.</p>
<p>Tehdään myös testi, joka varmistaa, että muistiinpanoa, jolle ei ole asetettu sisältöä, ei talleteta</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;note without content is not added&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
    important<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Molemmat testit tarkastavat lisäyksen jälkeen mihin tilaan tietokanta on päätynyt hakemalla kaikki sovelluksen muistiinpanot</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span></code></pre></div>
<p>Sama tulee toistumaan myöhemminkin monissa testeissä ja operaatio kannattaakin eristää apufunktioon. Sijoitetaan se testien yhteyteen tiedostoon <i>tests/test_helper.js</i> </p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../models/note&#x27;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> initialNotes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">&#x27;HTML on helppoa&#x27;</span><span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">&#x27;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&#x27;</span><span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> nonExistingId <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span><span class="token punctuation">{</span> content<span class="token punctuation">:</span> <span class="token string">&#x27;willremovethissoon&#x27;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> note<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> notesInDb <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> notes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> note<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  initialNotes<span class="token punctuation">,</span> nonExistingId<span class="token punctuation">,</span> notesInDb
<span class="token punctuation">}</span></code></pre></div>
<p>Moduuli määrittelee funktion <em>notesInDb</em>, jonka avulla voidaan tarkastaa sovelluksen tietokannassa olevat muistiinpanot. Tietokantaan alustettava sisältö <em>initialNotes</em> on siirretty samaan tiedostoon. Määrittelimme myös tulevan varalta funktion <em>nonExistingId</em>, jonka avulla on mahdollista luoda tietokantaid, joka ei kuulu millekään kannassa olevalle oliolle.</p>
<p>Testit muuttuvat muotoon</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;supertest&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">const</span> helper <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./test_helper&#x27;</span><span class="token punctuation">)</span></span><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../app&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../models/note&#x27;</span><span class="token punctuation">)</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="gatsby-highlight-code-line">  <span class="token keyword">let</span> noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="gatsby-highlight-code-line">  noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;notes are returned as json&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;all notes are returned&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

<span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a specific note is within the returned notes&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> contents <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&#x27;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a valid note can be added &#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> <span class="token string">&#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;</span><span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>


<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> notesAtEnd <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span>notesAtEnd<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> contents <span class="token operator">=</span> notesAtEnd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span>  <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>
    <span class="token string">&#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;note without content is not added&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
    important<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>

<span class="gatsby-highlight-code-line">  <span class="token keyword">const</span> notesAtEnd <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="gatsby-highlight-code-line">  <span class="token function">expect</span><span class="token punctuation">(</span>notesAtEnd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> </code></pre></div>
<p>Promiseja käyttävä koodi toimii nyt ja testitkin menevät läpi. Olemme valmiit muuttamaan koodin käyttämään async/await-syntaksia.</p>
<p>Koodi muuttuu seuraavasti (huomaa, että käsittelijän alkuun on laitettava määre <em>async</em>):</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">notesRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> request<span class="token punctuation">.</span>body

  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> body<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> body<span class="token punctuation">.</span>important <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> body<span class="token punctuation">.</span>important<span class="token punctuation">,</span>
    date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> savedNote <span class="token operator">=</span> <span class="token keyword">await</span> note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>savedNote<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Koodiin jää kuitenkin pieni ongelma: virhetilanteita ei nyt käsitellä ollenkaan. Miten niiden suhteen tulisi toimia?</p>
<h3>virheiden käsittely ja async/await</h3>
<p>Jos sovellus POST-pyyntöä käsitellessään aiheuttaa jonkinlaisen ajonaikaisen virheen, syntyy jälleen tuttu tilanne:</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/58f3a7f3fa30d1a45c4330ee6f0c83d8/14be6/6.png"/></picture>
<p>eli käsittelemätön promisen rejektoituminen. Pyyntöön ei vastata tilanteessa mitenkään.</p>
<p>Async/awaitia käyttäessä kannattaa käyttää vanhaa kunnon <em>try/catch</em>-mekanismia virheiden käsittelyyn:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">notesRouter<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> request<span class="token punctuation">.</span>body

  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    content<span class="token punctuation">:</span> body<span class="token punctuation">.</span>content<span class="token punctuation">,</span>
    important<span class="token punctuation">:</span> body<span class="token punctuation">.</span>important <span class="token operator">===</span> undefined <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token punctuation">:</span> body<span class="token punctuation">.</span>important<span class="token punctuation">,</span>
    date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">try</span> <span class="token punctuation">{</span> </span><span class="gatsby-highlight-code-line">    <span class="token keyword">const</span> savedNote <span class="token operator">=</span> <span class="token keyword">await</span> note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">    response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>savedNote<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="gatsby-highlight-code-line">    <span class="token function">next</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span></span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Catch-lohkossa siis ainoastaan kutsutaan funktiota <em>next</em> siirretään poikkeuksen käsittely virheidenkäittelymiddlewarelle.</p>
<p>Muutoksen jälkeen testit menevät läpi.</p>
<p>Tehdään sitten testit yksittäisen muistiinpanon tietojen katsomiselle ja muistiinpanon poistolle:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a specific note can be viewed&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notesAtStart <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> noteToView <span class="token operator">=</span> notesAtStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment">// hightlight-start</span>
  <span class="token keyword">const</span> resultNote <span class="token operator">=</span> <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteToView<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>
<span class="token comment">// hightlight-end</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>resultNote<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>noteToView<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a note can be deleted&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notesAtStart <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> noteToDelete <span class="token operator">=</span> notesAtStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment">// hightlight-start</span>
  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteToDelete<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>
<span class="token comment">// hightlight-end</span>

  <span class="token keyword">const</span> notesAtEnd <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>notesAtEnd<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>
    helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> contents <span class="token operator">=</span> notesAtEnd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>noteToDelete<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Molemmat testit ovat rakenteeltaan samankaltaisia. Alustusvaiheessa ne hakevat kannasta yksittäisen muistiinpanon. Tämän jälkeen on itse testattava operaatio, joka on koodissa korostettuna. Lopussa tarkastetaan, että operaation tulos on haluttu. </p>
<p>Testit menevät läpi, joten voimme turvallisesti refaktoroida testatut toutet käyttämään async/awaitia:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js">notesRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/:id&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>note<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>note<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

notesRouter<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">&#x27;/:id&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">findByIdAndRemove</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    response<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">exception</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Async/await ehkä selkeyttää koodia jossain määrin, mutta saavutettava hyöty ei ole sovelluksessamme vielä niin iso mitä se tulee olemaan jos asynkronisia kutsuja on tehtävä useampia. Async/awaitin &#x27;hinta&#x27; on poikkeusten käsittelyn edellyttämä iso <i>try/catch</i>-rakenne. Kaikki routejen käsittelijät noudattavatkin samaa kaavaa</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// do the async operations here</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">next</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Mieleen herää kysymys, olisiko koodia mahdollista refaktoroida siten, että <i>catch</i> saataisiin refaktoroitua ulos metodeista? Siihen on olemassa eräitä ratkaisuja mutta koska ne muuttavat koodia kompleksisemmaksi, jätämme sen ennalleen.</p>
<p>Kaikki eivät ole vakuuttuneita siitä, että async/await on hyvä lisä Javascriptiin, lue esim. <a href="https://spion.github.io/posts/es7-async-await-step-in-the-wrong-direction.html">ES7 async functions - a step in the wrong direction</a></p>
<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-4">githubissa</a>, haarassa <i>part4-4</i>. Samassa on &quot;vahingossa&quot; mukana testeistä seuraavan luvun jälkeinen paranneltu versio.</p>
<h3>Testin beforeEach-metodin optimointi</h3>
<p>Palataan takaisin testien pariin, ja tarkastellaan määrittelemäämme testit alustavaa funktiota <em>beforeEach</em>:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">let</span> noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Funktio tallettaa tietokantaan taulukon <em>helper.initialNotes</em> nollannen ja ensimmäisen alkion, kummankin erikseen taulukon alkioita indeksöiden. Ratkaisu on ok, mutta jos haluaisimme tallettaa alustuksen yhteydessä kantaan useampia alkioita, olisi toisto parempi ratkaisu:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;cleared&#x27;</span><span class="token punctuation">)</span>

  helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>note<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>
    <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;saved&#x27;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;done&#x27;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;notes are returned as json&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#x27;entered test&#x27;</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Talletamme siis taulukossa olevat muistiinpanot tietokantaan <em>forEach</em>-loopissa. Testeissä kuitenkin ilmenee jotain häikkää, ja sitä varten koodin sisään on lisätty aputulosteita.</p>
<p>Konsoliin tulostuu</p>
<pre>

cleared
done
entered test
saved
saved
</pre>
<p>Yllättäen ratkaisu ei async/awaitista huolimatta toimi niin kuin oletamme, testin suoritus aloitetaan ennen kuin tietokannan tila on saatu alustettua!</p>
<p>Ongelma on siinä, että jokainen forEach-loopin läpikäynti generoi oman asynkronisen operaation ja <em>beforeEach</em> ei odota näiden suoritusta. Eli forEach:in sisällä olevat <em>await</em>-komennot eivät ole funktiossa <em>beforeEach</em> vaan erillisissä funktioissa, joiden päättymistä <em>beforeEach</em> ei odota.</p>
<p>Koska testien suoritus alkaa heti <em>beforeEach</em> metodin suorituksen jälkeen, testien suoritus ehditään aloittamaan ennen kuin tietokanta on alustettu toivottuun alkutilaan.</p>
<p>Toimiva ratkaisu tilanteessa on odottaa asynkronisten talletusoperaatioiden valmistumista <em>beforeEach</em>-funktiossa, esim. metodin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all</a> avulla:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> helper<span class="token punctuation">.</span>noteObjects <span class="token operator">=</span> initialNotes
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> promiseArray <span class="token operator">=</span> noteObjects<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promiseArray<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Ratkaisu on varmasti aloittelijalle tiiviydestään huolimatta hieman haastava. Taulukkoon <em>noteObjects</em> talletetaan taulukkossa <em>helper.initialNotes</em> olevaia Javascript-oliota vastaavat <em>Note</em>-konstruktorifunktiolla generoidut mongoose-oliot. Seuraavalla rivillä luodaan uusi taulukko, joka <em>muodostuu promiseista</em>, jotka saadaan kun jokaiselle <em>noteObjects</em> taulukon alkiolle kutsutaan metodia <em>save</em>, eli ne talletetaan kantaan.</p>
<p>Metodin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all</a> avulla saadaan koostettua taulukollinen promiseja yhdeksi promiseksi, joka valmistuu, eli menee tilaan <i>fulfilled</i> kun kaikki sen parametrina olevan taulukon promiset ovat valmistuneet.
Siispä viimeinen rivi, <em>await Promise.all(promiseArray)</em> odottaa, että kaikki tietokantaan talletetusta vastaavat promiset ovat valmiina, eli alkiot on talletettu tietokantaan.</p>
<blockquote>
<p>Promise.all-metodia käyttäessä päästään tarvittaessa käsiksi sen parametrina olevien yksittäisten promisejen arvoihin, eli promiseja vastaavien operaatioiden tuloksiin. Jos odotetaan promisejen valmistumista <em>await</em>-syntaksilla <em>const results = await Promise.all(promiseArray)</em> palauttaa operaatio taulukon, jonka alkioina on <em>promiseArray</em>:n promiseja vastaavat arvot samassa järjestyksessä kuin promiset ovat taulukossa.</p>
</blockquote>
<p>Promise.all suorittaa kaikkia syötteenä saamiaan promiseja rinnakkain. Jos operaatioiden suoritusjärjestyksellä on merkitystä, voi tämä aiheuttaa ongelmia. Tällöin asynkroniset operaatiot on mahdollista määrittää <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/for...of">for...of</a> lohkon sisällä, jonka suoritusjärjestys on taattu.</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> note <span class="token keyword">of</span> initialNotes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> noteObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span>
    <span class="token keyword">await</span> noteObject<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Javascriptin asynkroninen suoritusmalli aiheuttaakin siis helposti yllätyksiä ja myös async/await-syntaksin kanssa pitää olla koko ajan tarkkana. Vaikka async/await peittää monia promisejen käsittelyyn liittyviä seikkoja, promisejen toiminta on syytä tuntea mahdollisimman hyvin!</p>
</div></div>
<div class="banner spacing spacing--after tasks" style="background-color:#F7F382"><div class="container"><div class="course-content col-6 push-right-3" style="border-color:#F7F382">
<h3>Tehtäviä</h3>
<p><strong>Huom</strong> materiaalissa käytetään muutamaan kertaan ekspektaatiota <a href="https://facebook.github.io/jest/docs/en/expect.html#tocontainitem">toContain</a> tarkastettaessa että jokin arvo on taulukossa. Kannattaa huomata, että metodi käyttää samuuden vertailuun ===-operaattoria ja olioiden kohdalla tämä ei ole useinkaan se mitä halutaan ja parempi vaihtoehto onkin <a href="https://facebook.github.io/jest/docs/en/expect.html#tocontainequalitem">toContainEqual</a>.</p>
<p><strong>Varoitus</strong> Jos huomaat kirjoittavasi sekaisin async/awaitia ja <i>then</i>-kutsuja, on 99% varmaa, että teet jotain väärin. Käytä siis jompaa kumpaa tapaa, älä missään tapauksessa &quot;varalta&quot; molempia.</p>
<h4>4.8: blogilistan testit, osa 1</h4>
<p>Tee API-tason testit blogilistan osoitteeseen /api/blogs tapahtuvalle HTTP GET -pyynnölle.</p>
<p>Kun testi on valmis, refaktoroi operaatio käyttämään promisejen sijaan async/awaitia.</p>
<p>Huomaa, että joudut tekemään koodiin osan 4 materiaalin tyylin joukon muutoksia (mm. testausympäristön määrittely), jotta saat järkevästi määriteltyä API-tason testejä.</p>
<p><strong>Huom</strong> testien kehitysvaiheessa ei yleensä kannata suorittaa joka kerta kaikkia testejä, vaan keskittyä yhteen testiin kerrallaan. On useita tapoja, joilla voidaan rajoittaa jestin suorittamia testejä. Esim. komennolla</p>
<div class="gatsby-highlight" data-language="bash"><pre><code class="language-bash">npx jest -t <span class="token string">&#x27;blogs are returned&#x27;</span></code></pre></div>
<p>voidaan suorittaa ainoastaan ne testit, joiden nimessä esiintyy teksti <i>blogs are returned</i>.</p>
<h4>4.9: blogilistan testit, osa 2</h4>
<p>Tee testit blogin lisäämiselle, eli osoitteeseen /api/blogs tapahtuvalle HTTP POST -pyynnölle.</p>
<p>Kun testi on valmis, refaktoroi operaatio käyttämään promisejen sijaan async/awaitia.</p>
<h4>4.10*: blogilistan testit, osa 3</h4>
<p>Tee testi joka varmistaa, että jos kentälle <i>likes</i> ei anneta arvoa, asetetaan sen arvoksi 0. Muiden kenttien sisällöstä ei tässä tehtävässä vielä välitetä.</p>
<p>Laajenna ohjelmaa siten, että testi menee läpi.</p>
<h4>4.11*: blogilistan testit, osa 4</h4>
<p>Tee testit blogin lisäämiselle, eli osoitteeseen <i>/api/blogs</i> tapahtuvalle HTTP POST -pyynnölle, joka varmistaa, että jos uusi blogi ei sisällä kenttiä <i>title</i> ja <i>url</i>, pyyntöön vastataan statuskoodilla <i>400 Bad request</i></p>
<p>Laajenna toteutusta siten, että testit menevät läpi.</p>
</div></div></div>
<div class="container"><div class="course-content col-6 push-right-3">
<h3>Testien refaktorintia</h3>
<p>Testit ovat tällä hetkellä osittain epätäydelliset, esim. reittejä <i>GET /api/notes/:id</i> ja <i>DELETE /api/notes/:id</i> ei tällä hetkellä testata epävalidien id:iden osalta. Myös testien organisoinnissa on hieman toivomisen varaa, sillä kaikki on kirjoitettu suoraan testifunktion &quot;päätasolle&quot;, parempaan luettavuuteen pääsisimme eritellessä loogisesti toisiinsa liittyvät testit <i>describe</i>-lohkoihin.</p>
<p>Jossain määrin parannellut testit seuraavassa:</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> supertest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;supertest&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;mongoose&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> helper <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./test_helper&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../app&#x27;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token function">supertest</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token keyword">const</span> Note <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;../models/note&#x27;</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;when there is initially some notes saved&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> Note<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> noteObjects <span class="token operator">=</span> helper<span class="token punctuation">.</span>initialNotes
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Note</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> promiseArray <span class="token operator">=</span> noteObjects<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>note <span class="token operator">=&gt;</span> note<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promiseArray<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;notes are returned as json&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> api
      <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;all notes are returned&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a specific note is within the returned notes&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> contents <span class="token operator">=</span> response<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>
      <span class="token string">&#x27;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&#x27;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;viewing a specifin note&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;succeeds with a valid id&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> notesAtStart <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> noteToView <span class="token operator">=</span> notesAtStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

      <span class="token keyword">const</span> resultNote <span class="token operator">=</span> <span class="token keyword">await</span> api
        <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteToView<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>

      <span class="token function">expect</span><span class="token punctuation">(</span>resultNote<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEqual</span><span class="token punctuation">(</span>noteToView<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;fails with statuscode 404 if note does not exist&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> validNonexistingId <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">nonExistingId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>validNonexistingId<span class="token punctuation">)</span>

      <span class="token keyword">await</span> api
        <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>validNonexistingId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;fails with statuscode 400 id is invalid invalid&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> invalidId <span class="token operator">=</span> <span class="token string">&#x27;5a3d5da59070081a82a3445&#x27;</span>

      <span class="token keyword">await</span> api
        <span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>invalidId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;addition of a new note&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;succeeds with valid data&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
        content<span class="token punctuation">:</span> <span class="token string">&#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;</span><span class="token punctuation">,</span>
        important<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">await</span> api
        <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>


      <span class="token keyword">const</span> notesAtEnd <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>notesAtEnd<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> contents <span class="token operator">=</span> notesAtEnd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>n <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>
        <span class="token string">&#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;fails with status code 400 if data invaild&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> newNote <span class="token operator">=</span> <span class="token punctuation">{</span>
        important<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">await</span> api
        <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/notes&#x27;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newNote<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> notesAtEnd <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token function">expect</span><span class="token punctuation">(</span>notesAtEnd<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#x27;deletion of a note&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;succeeds with status code 200 if id is valid&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> notesAtStart <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> noteToDelete <span class="token operator">=</span> notesAtStart<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

      <span class="token keyword">await</span> api
        <span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>noteToDelete<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">)</span>

      <span class="token keyword">const</span> notesAtEnd <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">notesInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token function">expect</span><span class="token punctuation">(</span>notesAtEnd<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>
        helper<span class="token punctuation">.</span>initialNotes<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token punctuation">)</span>

      <span class="token keyword">const</span> contents <span class="token operator">=</span> notesAtEnd<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span>content<span class="token punctuation">)</span>

      <span class="token function">expect</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toContain</span><span class="token punctuation">(</span>noteToDelete<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>Testien raportointi tapahtuu <i>describe</i>-lohkojen ryhmittelyn mukaan:</p>
<picture><img style="border-color:#F7F382" alt="fullstack content" src="/static/e01cd957a7650eae2082279222b7cb5a/14be6/7.png"/></picture>
<p>Testeihin jää vielä parannettavaa mutta on jo aika siirtyä eteenpäin.</p>
<p>Käytetty tapa API:n testaamiseen, eli HTTP-pyyntöinä tehtävät operaatiot ja tietokannan tilan tarkastelu Mongoosen kautta ei ole suinkaan ainoa tai välttämättä edes paras tapa tehdä API-tason integraatiotestausta. Universaalisti parasta tapaa testien tekoon ei ole, vaan kaikki on aina suhteessa käytettäviin resursseihin ja testattavaan ohjelmistoon.</p>
<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/fullstack-hy2019/part3-notes-backend/tree/part4-5">githubissa</a>, branchissa <i>part4-5</i></p>
</div></div>
<div class="banner spacing spacing--after tasks" style="background-color:#F7F382"><div class="container"><div class="course-content col-6 push-right-3" style="border-color:#F7F382">
<h2>Tehtäviä</h2>
<h4>4.12* blogilistan laajennus, osa 1</h4>
<p>Refaktoroi projektin testit siten, että ne eivät enää ole riippuvaisia siitä, että HTTP GET -operaatioiden testit suoritetaan ennen uusien blogien lisäämisen testaamista. Määrittele myös sopivia apumetodeja, joiden avulla saat poistettua testeistä copypastea:</p>
<p>Testit voivat tämän tehtävän jälkeen noudattaa esim. osan 4 luvun <a href="/osa4#testien-refaktorointi">Testien refaktorointi</a> tyyliä</p>
<div class="gatsby-highlight" data-language="js"><pre><code class="language-js"><span class="token keyword">const</span> helper <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;./test_helper&#x27;</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&#x27;a valid blog can be added&#x27;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newBlog <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ....</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> blogsBefore <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">blogsInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">await</span> api
    <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#x27;/api/blogs&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>newBlog<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">&#x27;Content-Type&#x27;</span><span class="token punctuation">,</span> <span class="token regex">/application\/json/</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> blogsAfter <span class="token operator">=</span> <span class="token keyword">await</span> helper<span class="token punctuation">.</span><span class="token function">blogsInDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>blogsAfter<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>blogsBefore<span class="token punctuation">.</span>length<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>blogsAfter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toContainEqual</span><span class="token punctuation">(</span>newBlog<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<h4>4.13 blogilistan laajennus, osa 2</h4>
<p>Toteuta sovellukseen mahdollisuus yksittäisen blogin poistoon.</p>
<p>Käytä async/awaitia. Noudata operaation HTTP-rajapinnan suhteen <a href="/osa3#rest">RESTful</a>-käytänteitä.</p>
<p>Saat toteuttaa ominaisuudelle testit jos haluat. Jos et, varmista ominaisuuden toimivuus esim. Postmanilla.</p>
<h4>4.14* blogilistan laajennus, osa 3</h4>
<p>Toteuta sovellukseen mahdollisuus yksittäisen blogin muokkaamiseen.</p>
<p>Käytä async/awaitia.</p>
<p>Tarvitsemme muokkausta lähinnä <i>likejen</i> lukumäärän päivittämiseen. Toiminnallisuuden voi toteuttaa samaan tapaan kuin muistiinpanon päivittäminen toteutettiin <a href="/osa3#loput-operaatiot">osassa 3</a>.</p>
<p>Saat toteuttaa ominaisuudelle testit jos haluat. Jos et, varmista ominaisuuden toimivuus esim. Postmanilla.</p>
</div></div></div></div><div class="container spacing element--flex element--centered"><a class="edit-link" target="__BLANK" href="https://github.com/fullstack-hy2019/fullstack-hy2019.github.io/edit/source/src/content/osa4/osa4a.md">Ehdota muutosta materiaalin sisältöön</a></div><div class="container spacing spacing--after-large prev-next__container "><a class="col-4--mobile push-right-1 prev" href="/osa3"><div class=" element--flex element--column"><p>Osa <!-- -->3</p><b>Edellinen osa</b></div></a><a class="col-4--mobile push-left-1 next" href="/osa5"><div class=" element--flex element--column"><p>Osa <!-- -->5</p><b>Seuraava osa</b></div></a></div></div><div class="container spacing--after-small spacing--mobile element--flex" id="footer"><div class="col-5 col-10--mobile order-2--mobile footer__links element--flex element--space-between"><a href="https://www.helsinki.fi/" class="col-5 col-4--mobile spacing--mobile"><div class="image col-6 image--contain"><div class="image__container"><img style="background-color:;background-opacity:0.5" class="image__content" src="/static/hgin_yliopisto-30c68104749d830b6cef6ea8c6339b16.png" alt="Helsingin yliopiston logo"/></div></div></a><a href="https://www.houston-inc.com/" class="col-5 col-4--mobile spacing--mobile"><div class="image col-6 image--contain"><div class="image__container"><img style="background-color:;background-opacity:0.5" class="image__content" src="/static/houston_logo-356bd2a9a75b44bdf7897b2cdd387600.png" alt="Houston inc. logo"/></div></div></a></div><div class="col-5 col-5--mobile order-1--mobile footer__navigation element--flex"><a class="footer__navigation-link nav-item-hover col-10--mobile" style="margin-left:4.5rem" href="/about">KURSSISTA</a><a class="footer__navigation-link nav-item-hover col-10--mobile" style="margin-left:4.5rem" href="/#course-contents">KURSSIN SISÄLTÖ</a><a class="footer__navigation-link nav-item-hover col-10--mobile" style="margin-left:4.5rem" href="/faq">FAQ</a></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-content-template-js","jsonName":"osa-4-sovelluksen-rakenne-ja-testauksen-alkeet-058","path":"/osa4/sovelluksen_rakenne_ja_testauksen_alkeet"};window.dataPath="305/path---osa-4-sovelluksen-rakenne-ja-testauksen-alkeet-058-b44-dvrCmWnaqg5szKs3E2gITf7uec";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app.f588656cc80a065e5f1e.css","/app-4587c720de4a14625975.js"],"component---src-templates-part-intro-template-js":["/component---src-templates-part-intro-template-js.d6d3dd1b5d88eb2952b1.css","/component---src-templates-part-intro-template-js-93713708feb7e7727fc9.js"],"component---src-templates-content-template-js":["/component---src-templates-content-template-js.1385f836cbf7ad252820.css","/component---src-templates-content-template-js-b9333370503a7987b2f7.js"],"component---src-pages-404-js":["/component---src-pages-404-js.8d4a7977feb76fc76984.css","/component---src-pages-404-js-da71c62f83602f8a130d.js"],"component---src-pages-about-js":["/component---src-pages-about-js.016d541d593372152c39.css","/component---src-pages-about-js-df7c6fd232c153361528.js"],"component---src-pages-companies-js":["/component---src-pages-companies-js.8d4a7977feb76fc76984.css","/component---src-pages-companies-js-1ba8024a747c5cc84ec6.js"],"component---src-pages-faq-js":["/component---src-pages-faq-js.79b882b76cf01573a4f7.css","/component---src-pages-faq-js-79a43ec8ec078e945cc5.js"],"component---src-pages-index-js":["/component---src-pages-index-js.8376cb274ee702a24c1b.css","/component---src-pages-index-js-d216f98f8115421fab68.js"]};/*]]>*/</script><script src="/webpack-runtime-5a19fe3c89021bc3230c.js" async=""></script><script src="/3-7bca983c2bafa9f6e675.js" async=""></script><script src="/0-2703ff4545207292aaf8.js" async=""></script><script src="/2-e0028e5792f6cb5e6fe8.js" async=""></script><script src="/component---src-templates-content-template-js-b9333370503a7987b2f7.js" async=""></script><script src="/1-456d0b929a90ce0c027e.js" async=""></script><script src="/app-4587c720de4a14625975.js" async=""></script></body></html>